---
title: "06a-Label capture areas as individual sections for separation"
output: html_document
date: "2024-08-15"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(SpatialExperiment)
library(ggplot2)
library(gridExtra)
library(spatialLIBD)

## rstudio GUI tweaks
require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")
##

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc. seemed to need this a couple times, but otherwise havent so its here as a preventative measure. part of this is adding the line 
# OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
# to Renviron.site. see e.g. top response on https://stackoverflow.com/questions/73638290/python-on-mac-is-it-safe-to-set-objc-disable-initialize-fork-safety-yes-globall 
library(parallelly)
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost="localhost")


## ggplot defaults

## last of all, unload the base package datasets, whose data keep getting in the way of autocompletions (e.g., Theoph is priortized over TRUE)
unloadNamespace("datasets")
```

## the way Lukas Weber did this previously was to use array_row and array_col to demarcate the sections. To facilitate something similar, produce a temporary spatial plot of each capture area with y=array_row, x=array_col, and in_tissue as a colorized variable. plot over that horizontal and vertical gridlines in steps of 5 so that we can figure out where sections start and stop quicker.
```{r}
lc <- readRDS("processed-data/02_build_spe/spe_raw.rds")

tmpcd <- as.data.table(colData(lc))
tmpcd <- split(tmpcd,tmpcd$sample_id)
### just make a stupid simple x-y plot for this
plt <- mapply(
    tmpcd,names(tmpcd),SIMPLIFY = FALSE,
    FUN = function(x,y) {
        ggplot(x,aes(x=array_col,y=array_row,col=overlaps_tissue))+
            geom_point(size=0.4)+
            theme_minimal()+
            ggtitle(y)+
            geom_hline(yintercept = seq(0.25,(max(lc$array_row)+.25),5),colour="green",linewidth = 0.6)+
            geom_vline(xintercept = seq(0.25,(max(lc$array_col)+.25),5),colour = "green",linewidth = 0.6)
    }
)

pdf("~/Desktop/LC tissuegrid.pdf",width=48,height=48) 
do.call("grid.arrange",plt)
dev.off()



```

Alright, by drawing some lines on the PDF, we can ascertain all of the following:
V13B23-284_A1:
row<41 | (array_row==41 & array_col>65 & array_col<70)

V13B23-284_B1:
(row<35 & col<75)|(row<30&col>74)

V13B23-284_C1:
 (array_row>44 & array_row<array_col-18) | (array_row<45&array_row>31 & array_row<array_col-16) | (array_row<32 & array_row<=array_col-18)

V13B23-286_A1:
col<65

V13B23-366_A1: single section

V13F27-339_A1:
sides of a line defined as y=95-array_col

V13F27-339_B1:
array_col<52

V13MF27-339_C1:
array_row<37

V13F27-339_D1: (array_row<25&array_col<73) |  (array_row>25&array_row<30 & array_col<71) |  (array_row>29&array_row<40 & array_col<69) | (array_row>39&array_row<51 & array_col<73 )| (array_row>50&array_col<53)

V13M06-331_A1:
(array_row<31 & array_col <70) | (array_row<28&array_col>=70)

V13M06-331_B1:
array_row<40

V13M06-331_C1:
array_col<73

V13M06-331_D1:
(array_row<54&array_row<63) | (array_row>53&array_col<66)

V13M06-332_B1
(array_col<70&array_row<22) | (array_col<67&array_row>21)

V13M06-332_D1
(array_col>57&array_row<65) | (array_col<53&array_row>=65)

V13M06-333_B1
array_col<72

V13M06-333_C1
(array_col<79&array_row>13) | (array_row < 14 & array_row<95-array_col)

V13M06-333_D1
array_col<52

V13M06-386_A1
array_row<41

V13M06-386_B1
array_col < 50

V13M06-386_C1
array_row<7 | (array_row<30 & array_col<74) | (array_row>29&array_row<47 & array_col<61) | (array_row>46 & array_row<60 & array_col<54) | (array_row>59 & array_col<50)

V13M06-386_D1
array_col<48

V13M06-401_A1
sides of a line defined as y=104-array_col

V13M06-401_B1
 (array_row<25 & array_col<61) | (array_row>24 &array_col<59)

V13M06-401_C1
array_col<65

V13M06-401_D1
(array_row<41&array_col<71) | (array_row>40&array_col<73)

V13M06-402_B1
array_row<33

V13M06-402_C1
array_col<55

V13M06-402_D1
array_row<50

V13M06-403_A1
array_col<60

V13M06-403_B1
array_row>40: line defined by 95-array_col
array_row<41: line defined by 101-array_col

V13M06-403_C1
(array_row<45&array_col<65) | (array_row>44&array_col<55)

V13M06-403_D1
array_row<53: 95-array_col
array_row>52: 86-array_col

V13M06-404_A1
array_col<55

### which leaves a few that need interactive manual tracing, but not bad.
```{r}
## now, we can use the above to create a new column in corresponding sample's entry in tmpcd (a list already named by the sample id) to assign "section_1" or "section_2"

## first, we need to create a new column in each sample's data.table that will be used to assign the section
tmpcd <- lapply(tmpcd,function(x) {
    x[,section:=""]
    x
})

## now, we can assign the sections
# # slide 284: 
# V13B23-284_A1:
# row<41 | (array_row==41 & array_col>65 & array_col<70)
# 
# V13B23-284_B1:
# (row<35 & col<75)|(row<30&col>74)

tmpcd[["V13B23-284_A1"]][,section:=ifelse(array_row<41 | (array_row==41 & array_col>65 & array_col<70),"section_1","section_2")]

tmpcd[["V13B23-284_B1"]][,section:=ifelse((array_row<35 & array_col<75) | (array_row<30 & array_col>74),"section_1","section_2")]

tmpcd[["V13B23-284_C1"]][,section:=ifelse((array_row>44 & array_row<array_col-18) | (array_row<45&array_row>31 & array_row<array_col-16) | (array_row<32 & array_row<=array_col-18),"section_1","section_2")]

# # slide 286:
# V13B23-286_A1:
# col<65
tmpcd[["V13B23-286_A1"]][,section:=ifelse(array_col<65,"section_1","section_2")]

# # slide 366:
# V13B23-366_A1: single section
tmpcd[["V13B23-366_A1"]]$section <- "section_1"

# # slide 339:
# V13F27-339_A1:
# sides of a line defined as y=95-array_col
tmpcd[["V13F27-339_A1"]][,section:=ifelse(array_row<95-array_col,yes="section_1",no="section_2")]

# V13F27-339_B1:
# array_col<52
tmpcd[["V13F27-339_B1"]][,section:=ifelse(array_col<52,yes="section_1",no="section_2")]

# V13F27-339_C1:
# array_row<37
tmpcd[["V13F27-339_C1"]][,section:=ifelse(array_row<37,yes="section_1",no="section_2")]

# V13F27-339_D1 
# (array_row<25&array_col<73) |  (array_row>25&array_row<30 & array_col<71) |  (array_row>29&array_row<40 & array_col<69) | (array_row>39&array_row<51 & array_col<73 )| (array_row>50&array_col<53)
tmpcd[["V13F27-339_D1"]][,section:=ifelse((array_row<25&array_col<73) |  (array_row>24 & array_row<29 & array_col<72)|(array_row>28&array_col<70),"section_1","section_2")]


# # slide 331:
# V13M06-331_A1:
# (array_row<31 & array_col <70) | (array_row<28&array_col>=70)
tmpcd[["V13M06-331_A1"]][,section:=ifelse((array_row<31 & array_col <70) | (array_row<29&array_col>=70),yes="section_1",no="section_2")]

# V13M06-331_B1:
# array_row<40
tmpcd[["V13M06-331_B1"]][,section:=ifelse(array_row<40,yes="section_1",no="section_2")]

# V13M06-331_C1:
# array_col<73
tmpcd[["V13M06-331_C1"]][,section:=ifelse(array_col<73,yes="section_1",no="section_2")]

# V13M06-331_D1:
# (array_row<54&array_row<63) | (array_row>53&array_col<66)
tmpcd[["V13M06-331_D1"]][,section:=ifelse((array_row<54&array_col<63) | (array_row>53&array_col<66),yes="section_1",no="section_2")]

# V13M06-332_B1
# (array_col<70&array_row<22) | (array_col<67&array_row>21)
tmpcd[["V13M06-332_B1"]][,section:=ifelse((array_col<70&array_row<22) | (array_col<67&array_row>21),yes="section_1",no="section_2")]

# V13M06-332_D1
# (array_col>57&array_row<65) | (array_col<53&array_row>=65)
tmpcd[["V13M06-332_D1"]][,section:=ifelse((array_col<57&array_row<65) | (array_col<53&array_row>=65),yes="section_1",no="section_2")]

# V13M06-333_B1
# array_col<72
tmpcd[["V13M06-333_B1"]][,section:=ifelse(array_col<72,yes="section_1",no="section_2")]

# V13M06-333_C1
# (array_col<79&array_row>13) | (array_row < 14 & array_row<95-array_col)
tmpcd[["V13M06-333_C1"]][,section:=ifelse((array_col<79&array_row>13) |  (array_row < 14 & array_row<95-array_col),yes="section_1",no="section_2")]

# V13M06-333_D1
# array_col<52
tmpcd[["V13M06-333_D1"]][,section:=ifelse(array_col<52,yes="section_1",no="section_2")]

# V13M06-386_A1
# array_row<41
tmpcd[["V13M06-386_A1"]][,section:=ifelse(array_row<41,yes="section_1",no="section_2")]

# V13M06-386_B1
# array_col < 50
tmpcd[["V13M06-386_B1"]][,section:=ifelse(array_col<50,yes="section_1",no="section_2")]

# V13M06-386_C1
# array_row<7 | (array_row<30 & array_col<74) | (array_row>29&array_row<47 & array_col<61) | (array_row>46 & array_row<60 & array_col<54) | (array_row>59 & array_col<50)
tmpcd[["V13M06-386_C1"]][,section:=ifelse(array_row<7 | (array_row<30 & array_col<74) | (array_row>29&array_row<47 & array_col<61) | (array_row>46 & array_row<60 & array_col<54) | (array_row>59 & array_col<50),yes="section_1",no="section_2")]

# V13M06-386_D1
# array_col<48
tmpcd[["V13M06-386_D1"]][,section:=ifelse(array_col<48,yes="section_1",no="section_2")]

# V13M06-401_A1
# sides of a line defined as y=104-array_col
tmpcd[["V13M06-401_A1"]][,section:=ifelse(array_row<105-array_col,yes="section_1",no="section_2")]

# V13M06-401_B1
# (array_row<25 & array_col<61) | (array_row>24 &array_col<59)
tmpcd[["V13M06-401_B1"]][,section:=ifelse((array_row<25 & array_col<61) | (array_row>24 &array_col<59),yes="section_1",no="section_2")]

# V13M06-401_C1
# array_col<65
tmpcd[["V13M06-401_C1"]][,section:=ifelse(array_col<65,yes="section_1",no="section_2")]

# V13M06-401_D1
# (array_row<41&array_col<71) | (array_row>40&array_col<73)
tmpcd[["V13M06-401_D1"]][,section:=ifelse((array_row<41&array_col<71) | (array_row>40&array_col<73),yes="section_1",no="section_2")]

# V13M06-402_B1
# array_row<33
tmpcd[["V13M06-402_B1"]][,section:=ifelse(array_row<33,yes="section_1",no="section_2")]

# V13M06-402_C1
# array_col<55
tmpcd[["V13M06-402_C1"]][,section:=ifelse(array_col<55,yes="section_1",no="section_2")]

# V13M06-402_D1
# array_row<50
tmpcd[["V13M06-402_D1"]][,section:=ifelse(array_row<50,yes="section_1",no="section_2")]

# V13M06-403_A1
# array_col<60
tmpcd[["V13M06-403_A1"]][,section:=ifelse(array_col<60,yes="section_1",no="section_2")]

# V13M06-403_B1
# array_row>40: line defined by 95-array_col
# array_row<41: line defined by 101-array_col
tmpcd[["V13M06-403_B1"]][,section:=ifelse(array_row>40 & array_row<95-array_col,yes="section_1",no="section_2")]
tmpcd[["V13M06-403_B1"]][array_row<41 & array_row<101-array_col,section:="section_1"]

# V13M06-403_C1
# (array_row<45&array_col<65) | (array_row>44&array_col<55)
tmpcd[["V13M06-403_C1"]][,section:=ifelse((array_row<45&array_col<65) | (array_row>44&array_col<55),yes="section_1",no="section_2")]

# V13M06-403_D1
# array_row<53: 95-array_col
# array_row>52: 86-array_col
tmpcd[["V13M06-403_D1"]][,section:=ifelse(array_row<53 & array_row<95-array_col,yes="section_1",no="section_2")]
tmpcd[["V13M06-403_D1"]][array_row>52 & array_row<86-array_col,section:="section_1"]

# V13M06-404_A1
# array_col<55
tmpcd[["V13M06-404_A1"]][,section:=ifelse(array_col<55,yes="section_1",no="section_2")]
```

### concat together, assign as cluster labels to SPE, check with tissue itself visualized
```{r}
tmpcd2 <- rbindlist(tmpcd)
# can't have blank "" in a DataFrame I guess?
tmpcd2[section=="",section:="noneassigned"]
tmpcd2 <- DataFrame(tmpcd2,row.names=tmpcd2$key)[colnames(lc),]

colLabels(lc) <- tmpcd2$section
### plot the section assignments on the lc tissue for which we assigned a section
plt <- spatialLIBD::vis_grid_clus(lc[,lc$label!="noneassigned"],clustervar="label",return_plots = T,spatial=T,image_id="lowres",alpha=0.7,auto_crop = T)

pdf("~/Desktop/sectionassigncheck.pdf",height=48,width=48)
do.call("grid.arrange",plt)
dev.off()

## all look good. save the table
tmpcd2 <- as.data.table(tmpcd2,keep.rownames=T)
fwrite(tmpcd2,"processed-data/05_QC/06a-capture_areas_split_withOUT_slibd.txt",sep='\t',quote=F)
```

Manually trace in spatial libd browser:
284_D1
286_B1
332_A1
332_C1
333_A1
402_A1
404_B1
404_C1
404_D1

