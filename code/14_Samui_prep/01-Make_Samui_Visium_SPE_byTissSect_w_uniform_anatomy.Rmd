---
title: "01-Make_Samui_Visium_SPE_byTissSect_w_uniform_anatomy"
author: "Bernie Mulvey"
date: "2025-07-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(SpatialExperiment)
# library(SpatialFeatureExperiment)

## rstudio GUI tweaks
require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")
##

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc. seemed to need this a couple times, but otherwise havent so its here as a preventative measure. part of this is adding the line 
# OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
# to Renviron.site. see e.g. top response on https://stackoverflow.com/questions/73638290/python-on-mac-is-it-safe-to-set-objc-disable-initialize-fork-safety-yes-globall 
library(parallelly)
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost="localhost")

## last of all, unload the base package datasets, whose data keep getting in the way of autocompletions (e.g., Theoph is priortized over TRUE)
unloadNamespace("datasets")
```


We already have an SPE with a copy of the image slot for each tissue section so we can start from here.
```{r}
lc2 <- readRDS("processed-data/06-QCed_SPE_split_to_tissSections.RDS")
```

For each tissue section, we want dorsal down, medial left.
### WARNING : DISTORTS SOME SAMPLES (fiduc. frame and tissue end up misaligned and/or cut off, somehow) WHEN PLOTTING IN SPATIAL LIBD--need to set auto_crop=FALSE; unsure why. looks like maybe if the fiducial frame is not an equal distance from all four image boundaries it doesn't work. as long as we don't make figure panels from slibd doesn't matter. (not very space-efficient to use uncropped spatial images)

all angles clockwise and in spatialLIBD plotting space which is NOT always the orientation in the powerpoint

# V13M06-386_B1s1: 180
# V13M06-386_B1s2: 180
# V13B23-286_B1s1 (top in captured orientation): horiz mirror
# V13B23-286_B1s2: vert mirror
# V13M06-403_C1s1 (bottom  " " "): vert mirror
# V13M06-403_C1s2: horiz mirror
# V13M06-332_C1s1 (top in " "): no change?
# V13M06-332_C1s2: 180
# V13M06-403_B1s1 (bottom in native): 180
# V13M06-403_B1s2: -90
# V13F27-339_D1s1 (bottom " "): 180
# V13F27-339_D1s2: no change
# V13M06-332_A1s1 (top " "): horiz mirror
# V13M06-332_A1s2: vert mirror
# V13M06-404_C1s1 (top): 180
# V13M06-404_C1s2: 180
# V13M06-331_A1s1: 90, horiz mirror
# V13M06-331_A1s2: -90, horiz mirror
# V13M06-331_B1s1 (left): 90
# V13M06-331_B1s2: 90, vert mirror
# V13M06-331_C1s1 (bot): vert mirror
# V13M06-331_C1s2: vert mirror
# V13M06-331_D1s1 (bot): vert mirror
# V13M06-331_D1s2: vert mirror
# V13M06-333_A1s1: vert mirror
# V13M06-333_A1s2: vert mirror
# V13M06-333_B1s1: Vert mirror
# V13M06-333_B1s2: vert mirror
# V13M06-333_C1s1 (bot): 180
# V13M06-333_C1s2: no change
# V13M06-333_D1s1 (bot): vert mirror
# V13M06-333_D1s2: vert mirror
# V13M06-332_B1s1 (bot): vert mirror
# V13M06-332_B1s2: vert mirror
# V13M06-332_D1s1 (bot): 180
# V13M06-332_D1s2: horiz mirror
# V13M06-404_A1s1 (bot): vert mirror
# V13M06-404_A1s2: vert mirror
# V13M06-404_B1s1 : 180
# V13M06-404_B1s2: 180
# V13M06-404_D1s1: 180
# V13M06-404_D1s2: 180
# V13M06-403_A1s1: 180
# V13M06-403_A1s2: 180
# V13M06-403_D1s1 (botleft): 180
# V13M06-403_D1s2: no change
# V13M06-402_A1s1 (top): 180
# V13M06-402_A1s2: no change
# V13M06-402_B1s1 (l): 90, horiz flip
# V13M06-402_B1s2: 90, vert flip
# V13M06-402_C1s1 (bot): vert mirror 
# V13M06-402_C1s2: vert mirror
# V13M06-402_D1s1 (top): vert mirror
# V13M06-402_D1s2: vert mirror
# V13M06-401_A1s1 (bot): 180
# V13M06-401_A1s2: no change
# V13M06-401_B1s1 (bot): vert mirror
# V13M06-401_B1s2: vert mirror
# V13M06-401_C1s1 (bot): vert mirror
# V13M06-401_C1s2: horiz mirror
# V13M06-401_D1s1 (bot): 180
# V13M06-401_D1s2: no change
# V13M06-386_A1s1 (l): 90
# V13M06-386_A1s2: -90
# V13M06-386_C1s1 (bot): 180
# V13M06-386_C1s2: no change
# V13M06-386_D1s1 (bot): no change
# V13M06-386_D1s2: vert mirror
# V13B23-366_A1s1 (only): no change
# V13B23-284_A1s1 (l): 90, horiz flip
# V13B23-284_A1s2: 90, vert flip
# V13B23-284_B1s1 (l): no change
# V13B23-284_B1s2: 180
# V13B23-284_C1s1 (top): no change
# V13B23-284_C1s2: 180
# V13B23-284_D1s1 (r): vert flip
# V13B23-284_D1s2: horiz flip
# V13F27-339_A1s1 (bot): 180
# V13F27-339_A1s2: no change
# V13F27-339_B1s1 (bot): 180
# V13F27-339_B1s2: 180
# V13F27-339_C1s1 (l): 90
# V13F27-339_C1s2: -90
# V13B23-286_A1s1 (bot): 180
# V13B23-286_A1s2: no change

# saved a tabular copy of ^this^ in local_ref/samplexforms.txt
```{r}
xforms <- fread("local_ref/samplexforms.txt")
unique(xforms$xforms)
xforms[,xforms:=gsub(xforms,pattern="flip",replacement="mirror")]
xforms[,xforms:=gsub(xforms,pattern="Vert",replacement="vert")]

## make an object with the unchanged samples
nodelta <- xforms[xforms=="no change",sample]
lc3 <- lc2[,lc2$sample_id %in% nodelta]

# to prevent mistakes/save memory, remove these from the original
lc2 <- lc2[,!(lc2$sample_id %in% nodelta)]
xforms <- xforms[!(sample %in% nodelta)]
gc(full=T)

rm(nodelta)
```

now go thru each transformation. make a list to store the individual transformed objects that we'll add to lc3 at the end.

# 180s
```{r}
newsamp <- list()

oneeighty <- xforms[xforms=="180",sample]

i<-1
for (i in c(1:length(oneeighty))){
  tmp <- rotateObject(lc2,sample_id=oneeighty[i],degrees=180)
  newsamp[[(length(newsamp)+1)]] <- tmp
  names(newsamp)[length(newsamp)] <- oneeighty[i]
  
  lc2 <- lc2[,lc2$sample_id!=oneeighty[i]]
  rm(tmp)
  gc(full=T)

}
xforms <- xforms[xforms!="180"]

rm(i,oneeighty)
```

# horiz mirrors
```{r}
hm <- xforms[xforms=="horiz mirror",sample]

i<-1
for (i in c(1:length(hm))){
  tmp <- mirrorObject(lc2,sample_id=hm[i],axis="v")
  newsamp[[(length(newsamp)+1)]] <- tmp
  names(newsamp)[length(newsamp)] <- hm[i]
  
  lc2 <- lc2[,lc2$sample_id!=hm[i]]
  rm(tmp)
  gc(full=T)

}
xforms <- xforms[xforms!="horiz mirror"]
rm(hm,i)
```


# vert mirrors
```{r}
vm <- xforms[xforms=="vert mirror",sample]

i<-1
for (i in c(1:length(vm))){
  tmp <- mirrorObject(lc2,sample_id=vm[i],axis="h")
  newsamp[[(length(newsamp)+1)]] <- tmp
  names(newsamp)[length(newsamp)] <- vm[i]
  
  lc2 <- lc2[,lc2$sample_id!=vm[i]]
  rm(tmp)
  gc(full=T)

}
xforms <- xforms[xforms!="vert mirror"]
rm(vm,i)
```

# -90
```{r}
neg90 <- xforms[xforms=="-90",sample]

i<-1
for (i in c(1:length(neg90))){
  tmp <- rotateObject(lc2,sample_id=neg90[i],degrees=270)
  newsamp[[(length(newsamp)+1)]] <- tmp
  names(newsamp)[length(newsamp)] <- neg90[i]
  
  lc2 <- lc2[,lc2$sample_id!=neg90[i]]
  rm(tmp)
  gc(full=T)

}
xforms <- xforms[xforms!="-90"]
rm(neg90,i)
```


# +90
```{r}
pos90 <- xforms[xforms=="90",sample]

i<-1
for (i in c(1:length(pos90))){
  tmp <- rotateObject(lc2,sample_id=pos90[i],degrees=90)
  newsamp[[(length(newsamp)+1)]] <- tmp
  names(newsamp)[length(newsamp)] <- pos90[i]
  
  lc2 <- lc2[,lc2$sample_id!=pos90[i]]
  rm(tmp)
  gc(full=T)

}
xforms <- xforms[xforms!="90"]
rm(pos90,i)
```


# +90, horiz mirror
```{r}
pos90hm <- xforms[xforms=="90, horiz mirror",sample]

i<-1
for (i in c(1:length(pos90hm))){
  tmp <- rotateObject(lc2,sample_id=pos90hm[i],degrees=90)
  tmp <- mirrorObject(tmp,sample_id=pos90hm[i],axis="v")
  newsamp[[(length(newsamp)+1)]] <- tmp
  names(newsamp)[length(newsamp)] <- pos90hm[i]
  
  lc2 <- lc2[,lc2$sample_id!=pos90hm[i]]
  rm(tmp)
  gc(full=T)

}
xforms <- xforms[xforms!="90, horiz mirror"]
rm(pos90hm,i)
```

# +90, vert mirror
```{r}
pos90vm <- xforms[xforms=="90, vert mirror",sample]

i<-1
for (i in c(1:length(pos90vm))){
  tmp <- rotateObject(lc2,sample_id=pos90vm[i],degrees=90)
  tmp <- mirrorObject(tmp,sample_id=pos90vm[i],axis="h")
  newsamp[[(length(newsamp)+1)]] <- tmp
  names(newsamp)[length(newsamp)] <- pos90vm[i]
  
  lc2 <- lc2[,lc2$sample_id!=pos90vm[i]]
  rm(tmp)
  gc(full=T)

}
xforms <- xforms[xforms!="90, vert mirror"]
rm(pos90vm,i)
```


# -90, horiz mirror
```{r}
neg90hm <- xforms[xforms=="-90, horiz mirror",sample]

i<-1
for (i in c(1:length(neg90hm))){
  tmp <- rotateObject(lc2,sample_id=neg90hm[i],degrees=270)
  tmp <- mirrorObject(tmp,sample_id=neg90hm[i],axis="v")
  newsamp[[(length(newsamp)+1)]] <- tmp
  names(newsamp)[length(newsamp)] <- neg90hm[i]
  
  lc2 <- lc2[,lc2$sample_id!=neg90hm[i]]
  rm(tmp)
  gc(full=T)

}
xforms <- xforms[xforms!="-90, horiz mirror"]
rm(neg90hm,i)
```

# -90, vert mirror
```{r}
# none
# neg90vm <- xforms[xforms=="-90, vert mirror",sample]
# 
# i<-1
# for (i in c(1:length(neg90vm))){
#   tmp <- rotateObject(lc2,sample_id=neg90vm[i],degrees=270)
#   tmp <- mirrorObject(tmp,sample_id=neg90vm[i],axis="h")
#   newsamp[[(length(newsamp)+1)]] <- tmp
#   names(newsamp)[length(newsamp)] <- neg90vm[i]
#   
#   lc2 <- lc2[,lc2$sample_id!=neg90vm[i]]
#   rm(tmp)
#   gc(full=T)
# 
# }
# xforms <- xforms[xforms!="-90, vert mirror"]
# rm(neg90vm,i,xforms)

stopifnot(ncol(lc2)==0)
rm(lc2)
gc(full=T)
```

combine back into one spe
```{r}
i <-1
for (i in c(1:length(newsamp))){
  lc3 <- cbind(lc3,newsamp[[i]])
  newsamp[[i]] <- "done" # save memory
  gc(full=T)
}

length(unique(lc3$sample_id))
# 85 -- same as orig
dim(lc3) 
# 29877 x 132484 -- same as orig. so we didn't screw anything up toooo badly
rm(newsamp)
gc(full=T)
```

## rearrange to match original for posterity (and check that everything's there)
```{r}
tmpcd <- fread("processed-data/06-QCed_SPE_splitToTissSect_colData.txt")
stopifnot(all(tmpcd$rowname %in% colnames(lc3)))
# phew

lc3 <- lc3[,tmpcd$rowname]
```

## append clusters and genomic ancestry estimates; clean up metadata
```{r}
louvs <- readRDS("processed-data/07_featureSelection_dimred_harmony_clustering/04-Initial_louvLeid_res0.5-1-2_clusterings.RDS")
anno <- fread("processed-data/08_validitycheck_25hdg75svg_louv1/10-25hdg75svg_louv1_annots.txt")
louvs <- louvs$HARMONYlmbna_HDG_SVG_2575[,.(rn,snnHARMONYlmbna_HDG_SVG_2575_louv_res1)]
setnames(louvs,2,"clusid")
louvs <- merge.data.table(louvs,anno[,.(clusid,anno)],by="clusid")
louvs <- DataFrame(louvs,row.names=louvs$rn)[colnames(lc3),]
lc3$Domain <- louvs$anno
rm(louvs,anno)
####
# nm+- LC:
####
nm <- fread("processed-data/10_subclustering/04-LCsubclus-by-NM_otherclusts-by-LCorLCNMadjacency.txt")
nm[!(NMseg_subclus %in% c("LC_NMpos","LC_NMneg")),NMseg_subclus:="Other"]
nm[NMseg_subclus=="LC_NMpos",NMseg_subclus:="LC (NM-positive)"]
nm[NMseg_subclus=="LC_NMneg",NMseg_subclus:="LC (NM-negative)"]
nm <- DataFrame(nm,row.names=nm$rn)[colnames(lc3),]
lc3$LC_neuromelanin_or_other <- nm$NMseg_subclus
rm(nm)
####
# FLARE ancestry
####
flares <- fread("raw-data/ancestryAndHaplotypes/FLARE/global_ancestry_estimates.txt")
tmpcd <- as.data.table(colData(lc3),keep.rownames=T)
tmpcd[brnum=="Br6119(re-dis)",brnum:="Br6119"]
stopifnot(all(unique(tmpcd$brnum) %in% flares$ID))
tmpcd <- merge.data.table(tmpcd,flares,by.x="brnum",by.y="ID")
rm(flares)
####
# cleanup coldata
# names(tmpcd)
tmpcd <- tmpcd[,.(rn,sample_id,capture_id,array_row,array_col,sum_umi,sum_gene,expr_chrM,expr_chrM_ratio,APOE,Sex,Age,Visium_slide,sizeFactor,Kit,hemisphere,N_NMbodies,Prop_NM,Intensity_NM,CentroidSignalCount_NM,tissueNMscore,Domain,LC_neuromelanin_or_other,CEU,YRI,CHB)]
tmpcd <- DataFrame(tmpcd,row.names=tmpcd$rn)[colnames(lc3),]
tmpcd$rn <- NULL

colData(lc3) <- tmpcd

## save the SPE
saveRDS(lc3,"processed-data/14_Samui_prep/01-Samui_TissSect_SPE_RotsMirrors.RDS")
```

# plot check orientations
```{r}
library(spatialLIBD)
library(gridExtra)
library(ggplot2)
rownames(lc3) <- rowData(lc3)$gene_name

## do this in the same order the anatomy guide ppt is in
xforms <- fread("local_ref/samplexforms.txt")
plts <- lapply(xforms$sample,function(s){
  p <- vis_gene(lc3,sampleid = s,geneid = "DBH",pdf_file = NULL,spatial = T,return_plots = T,auto_crop = T,point_size = 1.3,alpha=0.3)
  p<-p+guides(color="none",fill="none")+theme(title=element_text(size=11))
  return(p)})

pdf("~/Desktop/Samuirotscheck.pdf",height=99,width=14)
do.call("grid.arrange",c(plts,ncol=4))
dev.off()
```

## some of these have an issue encountered previously where certain transformations screw up the coordinates of the spots relative to the tissue, in which case we just have to kinda guess and check values to change one or the other of the spatialCoords by until they're back in about the right place.
```{r}
scooch <- c(
  "V13M06-403_B1s2",
  "V13M06-331_A1s1",
  "V13M06-331_A1s2",
  "V13M06-331_B1s1",
  "V13M06-331_B1s2",
  "V13M06-402_B1s1",
  "V13M06-402_B1s2",
  "V13M06-386_A1s1",
  "V13M06-386_A1s2",
  "V13B23-284_A1s1",
  "V13B23-284_A1s2",
  "V13F27-339_C1s1",
  "V13F27-339_C1s2")

fixcrd <- lc3[,lc3$sample_id %in% scooch]
lc3.5 <- lc3[,!(lc3$sample_id %in% scooch)]
stopifnot(length(unique(lc3.5$sample_id))+length(unique(fixcrd$sample_id))==85)

testfixes <- list()
```

## 403_B1s2: slide up
```{r}
testfixes[["403B1s2"]] <- fixcrd[,fixcrd$sample_id=="V13M06-403_B1s2"]
spatialCoords(testfixes[["403B1s2"]])[,2] <- spatialCoords(testfixes[["403B1s2"]])[,2]-1600
# vis_gene(testfixes[[1]],sampleid="V13M06-403_B1s2",geneid="DBH",alpha=0.5)

testfixes[["331A1s1"]] <- fixcrd[,fixcrd$sample_id=="V13M06-331_A1s1"]
spatialCoords(testfixes[["331A1s1"]])[,1] <- spatialCoords(testfixes[["331A1s1"]])[,1]-1600
# vis_gene(testfixes[[2]],sampleid="V13M06-331_A1s1",geneid="DBH",alpha=0.5)

testfixes[["331A1s2"]] <- fixcrd[,fixcrd$sample_id=="V13M06-331_A1s2"]
spatialCoords(testfixes[["331A1s2"]])[,2] <- spatialCoords(testfixes[["331A1s2"]])[,2]-1600
# vis_gene(testfixes[[3]],sampleid="V13M06-331_A1s2",geneid="DBH",alpha=0.5)

testfixes[["331B1s1"]] <- fixcrd[,fixcrd$sample_id=="V13M06-331_B1s1"]
testfixes[["331B1s1"]] <- rotateObject(testfixes[["331B1s1"]],sample_id="V13M06-331_B1s1",degrees=180)
spatialCoords(testfixes[["331B1s1"]])[,2] <- spatialCoords(testfixes[["331B1s1"]])[,2]+4800
# vis_gene(testfixes[[4]],sampleid="V13M06-331_B1s1",geneid="DBH",alpha=0.5)

testfixes[["331B1s2"]] <- fixcrd[,fixcrd$sample_id=="V13M06-331_B1s2"]
spatialCoords(testfixes[["331B1s2"]])[,1] <- spatialCoords(testfixes[["331B1s2"]])[,1]+4800
# vis_gene(testfixes[[5]],sampleid="V13M06-331_B1s2",geneid="DBH",alpha=0.5)

testfixes[["402B1s1"]] <- fixcrd[,fixcrd$sample_id=="V13M06-402_B1s1"]
spatialCoords(testfixes[["402B1s1"]])[,1] <- spatialCoords(testfixes[["402B1s1"]])[,1]-1000
# vis_gene(testfixes[[6]],sampleid="V13M06-402_B1s1",geneid="DBH",alpha=0.5)

testfixes[["402B1s2"]] <- fixcrd[,fixcrd$sample_id=="V13M06-402_B1s2"]
spatialCoords(testfixes[["402B1s2"]])[,1] <- spatialCoords(testfixes[["402B1s2"]])[,1]+1000
# vis_gene(testfixes[[7]],sampleid="V13M06-402_B1s2",geneid="DBH",alpha=0.5)

testfixes[["386A1s1"]] <- fixcrd[,fixcrd$sample_id=="V13M06-386_A1s1"]
spatialCoords(testfixes[["386A1s1"]])[,1] <- spatialCoords(testfixes[["386A1s1"]])[,1]+1800
# vis_gene(testfixes[[8]],sampleid="V13M06-386_A1s1",geneid="DBH",alpha=0.5)

testfixes[["386A1s2"]] <- fixcrd[,fixcrd$sample_id=="V13M06-386_A1s2"]
spatialCoords(testfixes[["386A1s2"]])[,2] <- spatialCoords(testfixes[["386A1s2"]])[,2]-1700
# vis_gene(testfixes[[9]],sampleid="V13M06-386_A1s2",geneid="DBH",alpha=0.5)

testfixes[["284A1s1"]] <- fixcrd[,fixcrd$sample_id=="V13B23-284_A1s1"]
spatialCoords(testfixes[["284A1s1"]])[,1] <- spatialCoords(testfixes[["284A1s1"]])[,1]-1100
# vis_gene(testfixes[[10]],sampleid="V13B23-284_A1s1",geneid="DBH",alpha=0.5)

testfixes[["284A1s2"]] <- fixcrd[,fixcrd$sample_id=="V13B23-284_A1s2"]
spatialCoords(testfixes[["284A1s2"]])[,1] <- spatialCoords(testfixes[["284A1s2"]])[,1]+1100
spatialCoords(testfixes[["284A1s2"]])[,2] <- spatialCoords(testfixes[["284A1s2"]])[,2]+200
# vis_gene(testfixes[[11]],sampleid="V13B23-284_A1s2",geneid="DBH",alpha=0.5)

testfixes[["339C1s1"]] <- fixcrd[,fixcrd$sample_id=="V13F27-339_C1s1"]
spatialCoords(testfixes[["339C1s1"]])[,1] <- spatialCoords(testfixes[["339C1s1"]])[,1]+2600
# vis_gene(testfixes[[12]],sampleid="V13F27-339_C1s1",geneid="DBH",alpha=0.5)

testfixes[["339C1s2"]] <- fixcrd[,fixcrd$sample_id=="V13F27-339_C1s2"]
spatialCoords(testfixes[["339C1s2"]])[,2] <- spatialCoords(testfixes[["339C1s2"]])[,2]-2600
# vis_gene(testfixes[[13]],sampleid="V13F27-339_C1s2",geneid="DBH",alpha=0.5)
```

## now add these back to the full spe, reorganize to match original for posterity as before, and overwrite
```{r}
i <-1
for (i in c(1:length(testfixes))){
  lc3.5 <- cbind(lc3.5,testfixes[[i]])
  testfixes[[i]] <- "returned"
}
rm(i)

# make sure we have everything again
stopifnot(all(rownames(tmpcd) %in% colnames(lc3.5)))
# dim(lc3.5)
# length(unique(lc3.5$sample_id))

# reord
lc3.5 <- lc3.5[,rownames(tmpcd)]

# clean up, save
rm(lc3,fixcrd,plts,testfixes,tmpcd,xforms,neg90vm,scooch)
gc(full=T)

saveRDS(lc3.5,"processed-data/14_Samui_prep/01-Samui_TissSect_SPE_RotsMirrors.RDS")
```


seshinfo
```{r}
sessionInfo()
sessioninfo::session_info()
```
