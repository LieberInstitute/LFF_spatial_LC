---
title: "02-DEanalysis_minspots_alldata"
author: "Bernie Mulvey"
date: "2025-04-29"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(edgeR)
library(limma)

# library(SpatialFeatureExperiment)

## rstudio GUI tweaks
require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")
##

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc. seemed to need this a couple times, but otherwise havent so its here as a preventative measure. part of this is adding the line 
# OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
# to Renviron.site. see e.g. top response on https://stackoverflow.com/questions/73638290/python-on-mac-is-it-safe-to-set-objc-disable-initialize-fork-safety-yes-globall 
library(parallelly)
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost="localhost")
library(parallel)


## last of all, unload the base package datasets, whose data keep getting in the way of autocompletions (e.g., Theoph is priortized over TRUE)
unloadNamespace("datasets")
```

```{r}
dgel <- readRDS("processed-data/12_DEanalyses_removedsampsAndFinalNMseg/01a-DGElist_per_25HDG75SVGlouv1_clusterSexAPO_normFilt_10spotmin.RDS")

### to avoid any issues, replace "Br6119(re-dis)" with "Br6119" in the samples tables
dgel$samples$brnum[dgel$samples$brnum=="Br6119(re-dis)"] <- "Br6119"

## edgeR's not going to like the LC.1, so change it to LC
dgel$samples$clus_geno_group <- gsub(dgel$samples$clus_geno_group,pattern="\\.",replacement="")
dgel$samples$label <-  gsub(dgel$samples$label,pattern="\\.",replacement="")
rownames(dgel$samples) <- gsub(rownames(dgel$samples),pattern="\\.",replacement="")
colnames(dgel$counts) <- gsub(colnames(dgel$counts),pattern="\\.",replacement="")
```

## append global genetic ancestry proportion estimates (FLARE, 3-component CEU ancestry--the other two being YRI and CHB). this source file is intentionally not included in in github but is on JHPCE. The CHB proportions range 0.0001 to 0.01--so CEU is effectively the proportion that is not YRI, and we can just use CEU as the variable here.

```{r}
flares <- fread("raw-data/ancestryAndHaplotypes/FLARE/global_ancestry_estimates.txt")

tmpsamp <- as.data.table(dgel$samples,keep.rownames=T)
tmpsamp <- merge.data.table(tmpsamp,flares[,.(ID,YRI)],by.x="brnum",by.y="ID")

tmpsamp <- as.data.frame(tmpsamp,row.names=tmpsamp$rn)[rownames(dgel$samples),]
tmpsamp$rn <- NULL
dgel$samples <- tmpsamp

rm(flares,tmpsamp)

```

### specify contrasts: Sex, E4 vs E2, per cluster

### First try; not quite right but runnable
```{r}

# append a cluster-specific YRI propoprtion column (equivalent to label*YRI for each cluster)
tmpsamp <- as.data.table(dgel$samples,keep.rownames=T)
tmpsamp <- merge.data.table(tmpsamp,flares,by.x="brnum",by.y="ID")

## make a YRI column for each cluster, where all non-cluster samples are 0
subsamp <- lapply(unique(tmpsamp$label),FUN=function(x){
    tmptmp <- copy(tmpsamp)
    tmptmp[,newcol:=0]
    tmptmp[label==x,newcol:=YRI]
    ret <- tmptmp[,.(rn,newcol)]
    setnames(ret,"newcol",paste0(x,"_YRI"))
    return(ret)
})

for (sstmp in subsamp){
    tmpsamp <- merge.data.table(tmpsamp,sstmp,by="rn")
}
rm(subsamp,sstmp)

tmpsamp[,CEU:=NULL]
tmpsamp[,YRI:=NULL]
tmpsamp[,CHB:=NULL]


tmpsamp <- as.data.frame(tmpsamp,row.names=tmpsamp$rn)[rownames(dgel$samples),]
tmpsamp$rn <- NULL
dgel$samples <- tmpsamp
rm(flares)

## full design matrix with colnames matching clus geno group values
des <- model.matrix(~0 + 
                        clus_geno_group + 
                        LC1_YRI + 
                        v5HT1_YRI + 
                        v5HT2_YRI + 
                        X1_YRI + 
                        X2_YRI + 
                        X4_YRI + 
                        X7_YRI + 
                        X8_YRI + 
                        X9_YRI +
                        Age, 
                    data = dgel$samples)


colnames(des) <- gsub(colnames(des),pattern="clus_geno_group",replacement="")

### apply default edgeR low count filtering
dgel2 <- filterByExpr.DGEList(dgel,design = des)
dgel2 <- dgel[dgel2,]
rm(dgel)
gc(full=T)

## make sex and e4s vs e2s contrasts for each cluster
i<-1
for (i in c(1:length(unique(dgel2$samples$label)))){
    x <- unique(dgel2$samples$label)[i]
# trasts <- lapply(unique(dgel$samples$label),function(x){
    ## get groups for sex DE
    
    malepat <- paste0(x,"_M_")
    malegrps <- unique(grep(dgel2$samples$clus_geno_group,pattern=malepat,value=T))
    fempat <- paste0(x,"_F_")
    femgrps <- unique(grep(dgel2$samples$clus_geno_group,pattern=fempat,value=T))
    
    if(length(femgrps)!=length(malegrps)){
        if(length(femgrps)<length(malegrps)){
            mult <- length(femgrps)/length(malegrps) ## e.g., 4 male groups and 2 female groups -> 0.5 for ea male group, -1 for each female group (4*0.5-1*2)=0
        } else {
            mult <- length(femgrps)/length(malegrps) ## e.g., 2 male groups and 4 female groups --> 2 for each male group, -1 for each female group (2*2-1*4)=0
        }
    } else {mult <- 1}
    
    ### get groups for all E4 carriers vs all E2 carriers
    
    e4pat <- paste0("E4")
    e4grps <- unique(grep(dgel2$samples$clus_geno_group,pattern=e4pat,value=T))
    e4grps <- grep(e4grps,pattern=x,value=T)
    
    e2pat <- paste0("E2")
    e2grps <- unique(grep(dgel2$samples$clus_geno_group,pattern=e2pat,value=T))
    e2grps <- grep(e2grps,pattern=x,value=T)
    
    if(length(e4grps)!=length(e2grps)){
    if(length(e4grps)<length(e2grps)){
        e4e2mult <- length(e2grps)/length(e4grps)
    } else {
        e4e2mult <- length(e4grps)/length(e2grps)
    }
    } else {e4e2mult <- 1}
    
    ret <- makeContrasts(
        str2expression(
            paste0(x,"_Sex=",paste0("mult*(",paste0(malegrps,collapse="+"),")"),
               paste0("-(",paste0(femgrps,collapse="+"),")"))),
        
        str2expression(
            paste0(x,"_E4vE2=",paste0("e4e2mult*(",paste0(e4grps,collapse="+"),")"),
               paste0("-(",paste0(e2grps,collapse="+"),")"))),
    
        levels=des)
    
    colnames(ret) <- paste0(x,c("_Sex","_E4vsE2"))
    
    if(i==1){
        trastmat <- ret
    } else{ 
        trastmat <- cbind(trastmat,ret)
    }
}
rm(e2grps,e4grps,e2pat,e4pat,e4e2mult,femgrps,fempat,i,malegrps,malepat,mult,x,ret)


```

### 050625 - NOPE -- model matrix not full rank and like 20 coefs not estimated.
for readability make sure all levels are in the model matrix for all variables https://stackoverflow.com/questions/4560459/all-levels-of-a-factor-in-a-model-matrix-in-r

```{r}

## just make the design matrix manually, it's not going to work with multiple variables specified. ("Although an intercept-free design matrix has been coded using the 0+ notation, the intercept is only excluded from the first factor that is listed within the model.matrix function. In other words, the second and third factors added to the model.matrix function are parameterised as though there is an intercept term" https://bioconductor.org/packages/release/workflows/vignettes/RNAseq123/inst/doc/designmatrices.html). Plus, this way, we can give the columns names that are more manageable as we go which will make writing contrasts easier.

# des1 <- model.matrix(~0+label,data=dgel$samples)
# des2 <- model.matrix(~0+Sex,data=dgel$samples)
# des3 <- model.matrix(~0+APOE,data=dgel$samples)
# des4 <- model.matrix(~0+Age,data=dgel$samples)
# des5 <- model.matrix(~0+YRI,data=dgel$samples)

# ### combine these for the additive factors thatll come from each interaction term
# des <- as.data.table(cbind(des1,des2,des3,des4,des5),keep.rownames=T)

# ### simplify the cluster label names and APOE names
# colnames(des) <- gsub(colnames(des),pattern="label",replacement="")
# colnames(des) <- gsub(colnames(des),pattern="APOE",replacement="")

# ### now make the interaction term columns by iterating thru each label and each nonlabel level
# labs <- unique(dgel$samples$label)
# nonlabs <- names(des)[!(names(des) %in% c("rn",labs))]

# for (lab in labs){
#     for (nonlab in nonlabs){
#         des[,newcol:=0]
#         des[get(lab)==1,newcol:=get(nonlab)]
#         setnames(des,"newcol",paste0(lab,"_",nonlab))
#     }
# }

# rm(des1,des2,des3,des4,des5,lab,nonlab)
# gc(full=T)

# ## make sure design matrix is in the same row order as the count matrix's col order
# des<-as.data.frame(des,row.names=des$rn)[colnames(dgel$counts),]
# des$rn <- NULL

# ### make sure there aren't any dropout factors here (e.g., LC_E4het), otherwise we will have to specify the math for certain contrasts individually.
# stopifnot(!any(colSums(des)==0))

# ### apply default edgeR low count filtering
# dgel2 <- filterByExpr.DGEList(dgel,design = des)
# dgel2 <- dgel[dgel2,]

# ## make sex, e4, e2, YRI contrasts for each cluster
# for (i in c(1:length(labs))){
#     lab <- labs[i]

#     ret <- makeContrasts(
#         str2expression(
#             paste0(lab,"_Sex=",paste0(lab,"_SexM"," - ",lab,"_SexF"))),

#         str2expression(
#             paste0(lab,"_E4vE2=",paste0("(",lab,"_E4hom +",lab,"_E4het) -(",lab,"_E2hom -",lab,"_E2het)"))),
                
#         str2expression(
#             paste0(lab,"_E4HETvE2=",paste0(lab,"_E4het -(",lab,"_E2hom -",lab,"_E2het)"))),    

#         str2expression(
#             paste0(lab,"_E4HOMvE2=",paste0(lab,"_E4hom -(0.5*",lab,"_E2hom - 0.5*",lab,"_E2het)"))), 
            
#         str2expression(
#             paste0(lab,"_E4HOMvE4HET=",paste0(lab,"_E4hom - ",lab,"_E4het"))),
                
#         str2expression(
#             paste0(lab,"_E2HETvE4=",paste0(lab,"_E2het -(",lab,"_E4hom -",lab,"_E4het)"))),    

#         str2expression(
#             paste0(lab,"_E2HOMvE4=",paste0(lab,"_E2hom -(0.5*",lab,"_E4hom - 0.5*",lab,"_E4het)"))), 
            
#         str2expression(
#             paste0(lab,"_E2HOMvE2HET=",paste0(lab,"_E2hom - ",lab,"_E2het"))),

#     levels=des)

    
#     ## ook the column names don't come out the way i meant for it to be so
#     colnames(ret) <- paste0(lab,c("_Sex","_E4vsE2","_E4HETvE2","_E4HOMvE2","_E4HOMvE4HET","_E2HETvE4","_E2HOMvE4","_E2HOMvE2HET"))
    


#     if(i==1){
#         trastmat <- ret
#     } else{ 
#         trastmat <- cbind(trastmat,ret)
#     }
# }
# rm(i,ret,lab)
```

run DE
```{r}
v.swt <- voomLmFit(dgel2,design = des,block = as.factor(dgel2$samples$brnum),adaptive.span = T,sample.weights = T)

v.swt.fit <- contrasts.fit(v.swt,contrasts=trastmat) ## apo and sex
v.swt.fit.yri <- contrasts.fit(v.swt,coefficients = grep(colnames(des),pattern="YRI",value=T))

v.swt.fit.e <- eBayes(v.swt.fit)
v.swt.fit.yri.e <- eBayes(v.swt.fit.yri)

keeplist <- list(voomLFt=v.swt,
                 trastsFit=v.swt.fit,
                 yriFit=v.swt.fit.yri,
                 eBay=v.swt.fit.e,
                 eBayYRI=v.swt.fit.yri.e,
                 dgel=dgel2,
                 trasts=trastmat)

saveRDS(keeplist,"processed-data/12_DEanalyses_removedsampsAndFinalNMseg/02TESTa-allclust_sexAPOde_YRIde_results.RDS")
rm(keeplist)

detabs <- lapply(c(colnames(trastmat),grep(colnames(des),pattern="YRI",value=T)),FUN=function(t){
    if (t %in% colnames(trastmat)){
        restab <- as.data.table(topTable(v.swt.fit.e,coef = t,number=Inf,adjust.method = "BH"))
    } else {
        restab <- as.data.table(topTable(v.swt.fit.yri.e,coef = t,number=Inf,adjust.method = "BH"))
    }
    
    return(restab)
})
names(detabs) <- c(colnames(trastmat),grep(colnames(des),pattern="YRI",value=T))

saveRDS(detabs,"processed-data/12_DEanalyses_removedsampsAndFinalNMseg/02TESTa-allclust_sexAPO_YRI_deTabs.RDS")

### save local copies for quick plug into enrichr and similar tools
i <-1
for (i in c(1:length(detabs))){
    write.table(detabs[[i]][adj.P.Val<0.05&logFC>0,gene_name],paste0("~/Desktop/tmp/",names(detabs)[i],"_up.txt"),sep='\t',quote=F,row.names=F,col.names=F)
    write.table(detabs[[i]][adj.P.Val<0.05&logFC<0,gene_name],paste0("~/Desktop/tmp/",names(detabs)[i],"_down.txt"),sep='\t',quote=F,row.names=F,col.names=F)
}
```

```{r}
rm(list=ls())
gc(full=T)
```

reprod inf
```{r}
sessionInfo()
sessioninfo::session_info()
```
R version 4.4.3 (2025-02-28)
Platform: aarch64-apple-darwin20
Running under: macOS Sequoia 15.3.2

Matrix products: default
BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] parallel  stats     graphics  grDevices utils     methods   base     

other attached packages:
[1] BiocParallel_1.40.0 parallelly_1.43.0   colorout_1.3-0.2    edgeR_4.4.2        
[5] limma_3.62.2        data.table_1.17.0   rlang_1.1.5        

loaded via a namespace (and not attached):
 [1] digest_0.6.37     codetools_0.2-20  fastmap_1.2.0     xfun_0.51        
 [5] lattice_0.22-6    knitr_1.50        htmltools_0.5.8.1 rmarkdown_2.29   
 [9] cli_3.6.4         grid_4.4.3        statmod_1.5.0     compiler_4.4.3   
[13] rprojroot_2.0.4   here_1.0.1        rstudioapi_0.17.1 tools_4.4.3      
[17] evaluate_1.0.3    yaml_2.3.10       locfit_1.5-9.12  
> sessioninfo::session_info()
─ Session info ───────────────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.4.3 (2025-02-28)
 os       macOS Sequoia 15.3.2
 system   aarch64, darwin20
 ui       RStudio
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       America/Chicago
 date     2025-04-30
 rstudio  2024.07.0-daily+219 Cranberry Hibiscus (desktop)
 pandoc   3.1.11 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools/aarch64/ (via rmarkdown)
 quarto   1.4.555 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/quarto

─ Packages ───────────────────────────────────────────────────────────────────────────
 ! package      * version  date (UTC) lib source
   BiocParallel * 1.40.0   2024-11-23 [1] Bioconductor 3.20 (R 4.4.2)
 P cli            3.6.4    2025-02-13 [2] CRAN (R 4.4.1)
   codetools      0.2-20   2024-03-31 [1] CRAN (R 4.4.3)
   colorout     * 1.3-0.2  2024-05-01 [1] Github (jalvesaq/colorout@c6113a2)
   data.table   * 1.17.0   2025-02-22 [1] CRAN (R 4.4.1)
   digest         0.6.37   2024-08-19 [1] CRAN (R 4.4.1)
   edgeR        * 4.4.2    2025-01-27 [1] Bioconductor 3.20 (R 4.4.2)
   evaluate       1.0.3    2025-01-10 [1] CRAN (R 4.4.1)
   fastmap        1.2.0    2024-05-15 [1] CRAN (R 4.4.0)
   here           1.0.1    2020-12-13 [1] CRAN (R 4.4.0)
   htmltools      0.5.8.1  2024-04-04 [1] CRAN (R 4.4.0)
   knitr          1.50     2025-03-16 [1] CRAN (R 4.4.2)
   lattice        0.22-6   2024-03-20 [1] CRAN (R 4.4.3)
   limma        * 3.62.2   2025-01-09 [1] Bioconductor 3.20 (R 4.4.2)
   locfit         1.5-9.12 2025-03-05 [1] CRAN (R 4.4.1)
   parallelly   * 1.43.0   2025-03-24 [1] CRAN (R 4.4.1)
 P rlang        * 1.1.5    2025-01-17 [2] CRAN (R 4.4.1)
   rmarkdown      2.29     2024-11-04 [1] CRAN (R 4.4.1)
   rprojroot      2.0.4    2023-11-05 [1] CRAN (R 4.4.0)
   rstudioapi     0.17.1   2024-10-22 [1] CRAN (R 4.4.1)
   sessioninfo    1.2.3    2025-02-05 [1] CRAN (R 4.4.1)
   statmod        1.5.0    2023-01-06 [1] CRAN (R 4.4.0)
   xfun           0.51     2025-02-19 [1] CRAN (R 4.4.1)
   yaml           2.3.10   2024-07-26 [1] CRAN (R 4.4.0)

 [1] /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library
 [2] /Users/bmulvey/Library/R/arm64/4.4/library

 * ── Packages attached to the search path.
 P ── Loaded and on-disk path mismatch.

──────────────────────────────────────────────────────────────────────────────────────
