---
title: "12e-h-Compare_lcNMPosNeg_GRNs"
format: html
date: "2025-09-01"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(ggplot2)
library(ggtext)
library(gridExtra)
# library(SpatialFeatureExperiment)

## rstudio GUI tweaks
require(colorout)
ColorOut()
options('styler.addins_style_transformer' = 'biocthis::bioc_style()')
##

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc. seemed to need this a couple times, but otherwise havent so its here as a preventative measure. part of this is adding the line 
# OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
# to Renviron.site. see e.g. top response on https://stackoverflow.com/questions/73638290/python-on-mac-is-it-safe-to-set-objc-disable-initialize-fork-safety-yes-globall 
library(parallelly)
options(parallelly.supportsMulticore.disableOn='')
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost='localhost')


## ggplot defaults
theme_set(theme_bw()+theme(axis.text.x = element_text(size = 8,color = '#000000'), axis.title.x = element_text(size = 9,color = '#000000'), axis.text.y = element_text(size = 8,color = '#000000'), axis.title.y = element_text(size =9,color = '#000000'), plot.title = element_markdown(size = 10,hjust=0.5,color = '#000000'), strip.text = element_text(size=11), legend.text = element_text(size=7,color = '#000000'), legend.title = element_text(size=8,hjust=0.5,color = '#000000'),axis.ticks = element_line(linewidth=0.5),panel.grid.major = element_line(linewidth=0.5),panel.grid.minor=element_line(linewidth=0.25),plot.title.position='plot'))

## last of all, unload the base package datasets, whose data keep getting in the way of autocompletions (e.g., Theoph is priortized over TRUE)
unloadNamespace('datasets')
```


## Some additional guidance on using PANDA networks from the same lab as SCORPION comes via course materials at https://github.com/kuijjerlab/multi-omics-course/blob/main/multi-omics_workshop_full_code.ipynb
```{r}
scorpminfilt <- readRDS("processed-data/12_DEanalyses_removedsampsAndFinalNMseg/12a-LCNMpos_NMneg_scorpii_zerofilt_actual.RDS")
scorpaggrofilt <- readRDS("processed-data/12_DEanalyses_removedsampsAndFinalNMseg/12c-LCNMpos_NMneg_scorpii_pbulkGenesPreFilt_actual.RDS")

## get full networks
rnets <- list(nmp_minfilt=scorpminfilt$NMpos$regNet,
nmn_minfilt=scorpminfilt$NMneg$regNet,
nmp_aggrofilt=scorpaggrofilt$NMpos$regNet,
nmn_aggrofilt=scorpaggrofilt$NMneg$regNet
)

rm(scorpminfilt,scorpaggrofilt)
gc(full=TRUE)

### combine the NM+ and - networks to compare common edges 
rnets <- mapply(x=rnets,n=names(rnets),SIMPLIFY=FALSE,function(x,n){
  y <- as.data.table(as.data.frame(as.matrix(x)),keep.rownames=T)
  y <- melt.data.table(y,id.vars="rn")
  setnames(y,"value",gsub(n,pattern="^(.*)_.*$",replacement = "\\1"))
  setnames(y,c("rn","variable"),c("TF","gene"))
  return(y)
})

rnetsmin <- merge.data.table(rnets[[1]],rnets[[2]],by=c("TF","gene"))
rnetsfilt <- merge.data.table(rnets[[3]],rnets[[4]],by=c("TF","gene"))
rnets <- list(minfilt=rnetsmin,filt=rnetsfilt)
rm(rnetsmin,rnetsfilt)
```


## revising the coursework code for data.table, this is q/a 27 of the aforementioned ipynb:

# It is often very useful to determine the edges that best define the differences between two networks. In this case, we would like to select edges that are both likely to be "real" in a particular network (i.e. have a high edge weight) as well as "different" between the two networks. Because the weights of PANDA edges can be thought of as z-score units, edge-weights can be easily converted into probability values. Under this framework, we can multiply the probability that an edge is "real" by the probability that it is "different" between two networks to get a combined probability score representing whether an edge is both real and different. We can then select edges based on this combined probability score. In our example, we use the PANDA output matrices to select edges that have at least a 75% chance of being both real and different.

## a fresh check of my code weeks after originally writing checks out:
## == pnorm(edge weight in network of interest) * pnorm(interestedge-comparatoredge) 
```{r}
rnets <- lapply(rnets,function(x){
    x[,diff:=apply(.SD,MARGIN = 1,simplify=T,function(x){max(x[1],x[2])-min(x[1],x[2])}),.SDcols=c("nmp","nmn")]
    mindiff <- quantile(x$diff,0.95) # not using this for anything afaik

    x[,nmp_pn:=pnorm(nmp)] #nmp = edge weight NM+
    x[,nmn_pn:=pnorm(nmn)] #nmn = edge weight NM-
    ## comes out effed up with simplify=T, so manually unlist the column values after making them
    x[,nmp_spec:=apply(.SD,MARGIN=1,simplify=FALSE,function(x){ifelse(x[1]*pnorm(x[2]-x[3])>0.75,yes="Y",no="N")}),.SDcols=c("nmp_pn","nmp","nmn")]
    x[,nmn_spec:=apply(.SD,MARGIN=1,simplify=FALSE,function(x){ifelse(x[1]*pnorm(x[2]-x[3])>0.75,yes="Y",no="N")}),.SDcols=c("nmn_pn","nmn","nmp")]
    x[,nmn_spec:=unlist(nmn_spec)] 
    x[,nmp_spec:=unlist(nmp_spec)]

    return(x)
})

# get TF-gene edges that are specific to one of the networks
rnetspec <- lapply(rnets,function(x){
    y <- x[nmp_spec=="Y"|nmn_spec=="Y"]
    y <- y[!(nmp_spec=="Y"&nmn_spec=="Y")]# remove edges that score as specific to both networks, because that's obv not specific
    return(y)
})

# scatter plotem
ggplot(rnetspec[[1]],aes(x=nmn,y=nmp)) +
  geom_point(shape=21,size=1.5,stroke=0.25) +
  labs(x="NM- SCORPION edge weight",y="NM+ SCORPION edge weight",title="SCORPION NM+ vs NM- edge weights") +
  theme(legend.position = "bottom") +
  guides(fill=guide_colorbar(title="Edge weight difference"))

ggplot(rnetspec[[2]],aes(x=nmn,y=nmp)) +
  geom_point(shape=21,size=1.5,stroke=0.25) +
  labs(x="NM- SCORPION edge weight",y="NM+ SCORPION edge weight",title="SCORPION NM+ vs NM- edge weights") +
  theme(legend.position = "bottom") +
  guides(fill=guide_colorbar(title="Edge weight difference"))
# oho look at that, it's a scorpion!
```

## get list object to save: union of
# •TFs with > 80% of edges unique to in nm- and nm+ specific edges?
# this is agnostic to TF repressive/enhancing effect (i.e., if TF does some of each, it can still be included if vast majority of edges are specific to one network)
```{r}
rnetspectfs <- lapply(rnetspec,function(x){
    ## these columns are being added in-place by data.table so will ALSO become part of the rnetspec tables without explicitly returning them, handily.

    ## number of specific edges
    x[nmp_spec=="Y",Nposspec:=.N,by="TF"]
    x[nmn_spec=="Y",Nnegspec:=.N,by="TF"]
    ## number of total edges
    x[,Nedge:=.N,by="TF"]
    ## TFs totally unique to the other group should have a zero instead of NA for Nspec 
    x[is.na(Nposspec)&Nnegspec==Nedge,Nposspec:=0]
    x[is.na(Nnegspec)&Nposspec==Nedge,Nnegspec:=0]

    # combine
    filltab <- merge.data.table(
        unique(x[!is.na(Nnegspec),.(TF,Nnegspec)]),
        unique(x[!is.na(Nposspec),.(TF,Nposspec)]),
        by="TF",
        all.x=T,all.y=T)
    
    # calc NM+ spec edge proportion and NM- spec edge prop
    filltab[,posprop:=Nposspec/(Nposspec+Nnegspec)]
    filltab[,negprop:=1-posprop]
    retlist <- list(
        nmp_specTFs = filltab[posprop>0.8,TF],
        nmn_specTFs=filltab[negprop>0.8,TF]
    )

    return(retlist)
})
```

### the more aggressively filtered data has a more workable number of TFs and such, so we'll work with that for now. it's the higher confidence result anyhow
```{r}
rnet <- rnets$filt
rnetspec <- rnetspec$filt
rnetspectfs <- rnetspectfs$filt
rm(rnets)

## save the full edge comparison table
saveRDS(rnet,"processed-data/12_DEanalyses_removedsampsAndFinalNMseg/12e1-Pbulkprefilt_LCNMposNeg_GRNs_allEdges_edgeWtComparisonsAndDomainSpecEdgeCalls.RDS")
```

### for TFs with evidence of cluster-specific activity (i.e., above), add ALL of their edges to the network that's condition-specific edges only
```{r}
rnet_specEdgeORtf <- unique(rbind(rnetspec[,.(TF,gene,nmp,nmn,diff,nmp_pn,nmn_pn,nmp_spec,nmn_spec)],rnet[TF %in% unlist(rnetspectfs)]
))
### save these two filtered filtered-networks. fix gene being a factor to avoid confusion later
rnet[,gene:=as.character(gene)]
rnetspec[,gene:=as.character(gene)]
rnet_specEdgeORtf[,gene:=as.character(gene)]

rnetsout <- list(pbulkfilt_rnet_specEdgesOnly=rnetspec[,.(TF,gene,nmp,nmn,diff,nmp_pn,nmn_pn,nmp_spec,nmn_spec)],
    pbulkfilt_rnet_specEdge_or_EdgeWith80pctSpecTF=rnet_specEdgeORtf)

saveRDS(rnetsout,"processed-data/12_DEanalyses_removedsampsAndFinalNMseg/12e2
-Pbulkprefilt_LCNMposNeg_GRNs_NMdomainSpecEdge_or_SpecEdgeandSpecTF_filt.RDS")

rm(rnetsout)
```

## using the specific edges only (1669 edges), get a network of the largest-difference (effect) edges:
get edges that come out as being specific to a TF interaction from one network or the other, AND with differences larger than one of their directions edge weights or difference in edge weight >5, AND where NM+ or NM- edge weight is >2 --> 47 edges. put a sign on the edge weight difference to indicate more active network, and a column specifying whether the TF is acting as a repressor or enhancer in its most involved context.
```{r}
topdifnet <- rnetspec[diff>abs(nmp)|diff>abs(nmn)|diff>5][abs(nmp)>2|abs(nmn)>2]
topdifnet[,diff:=ifelse(nmp>nmn,yes=diff,no=-1*diff)]
topdifnet[,primaryefdir:=ifelse(abs(nmp)>abs(nmn),yes=sign(nmp),no=sign(nmn))]
fwrite(topdifnet,"processed-data/12_DEanalyses_removedsampsAndFinalNMseg/12f-NMgrns_DomspecEdges_wLargeDiffAndLargeEffect_net.txt",sep='\t',quote=F,row.names=F)
```

## MLX has most of the largest differences in the above and favoring NM+, so let's make a similar network but solely focused on MLX and its targets/regulators
```{r}
mlxplot <- rnet_specEdgeORtf[TF=="MLX"|gene=="MLX"]
## only 18 TFs targeting MLX, so get the top one for each
mlxplotregs <- unique(rbind(
    mlxplot[gene=="MLX"][abs(nmp)==max(abs(nmp))],
    mlxplot[gene=="MLX"][abs(nmn)==max(abs(nmn))]
))
# lol okay just autoregulation ^. now drop the MLX-as-target-rows
mlxplot <- mlxplot[gene!="MLX"]

## ## and top 10% of MLX's signed target edges, whichever ABSOLUTE edge weight is larger

# get larger of the absolute edge wt
mlxplot[,lgwt:=apply(.SD,MARGIN=1,simplify=T,function(x){max(abs(x[1]),abs(x[2]))}),.SDcols=c("nmp","nmn")]

# correct to match sign of the actual weight
mlxplot[lgwt==abs(nmp),lgwt:=nmp]
mlxplot[lgwt==abs(nmn),lgwt:=nmn]

## find the proportion of positive and negative larger-edge-weights
targupprop <- nrow(mlxplot[lgwt>0])/nrow(mlxplot)
## 0.778 of MLX's target edges are positive

# get target-effect-direction-proportionate number of top 2% highest edge weights, so
# 0.98 + (0.02 * (1-targupprop)) positive edges: >98.44ish %ile
# 0 + (0.02*(1-targupprop)) negative edges: <0.44ish %ile.
# something about working ^this out threw me for a massive fucking loop but the math works so okay 
mlxplot <- rbind(
    mlxplot[lgwt>quantile(lgwt,(0.98+(0.02*(1-targupprop))))],
    mlxplot[lgwt<quantile(lgwt,(0.02*(1-targupprop)))]
)

mlxplot[,lgwt:=NULL]
# add the MLX as target part
mlxplot <- as.data.table(rbind(mlxplot[],mlxplotregs))

fwrite(mlxplot,"processed-data/12_DEanalyses_removedsampsAndFinalNMseg/12g-MLX_largesteffectedges_net.txt",sep='\t',quote=F,row.names=F,col.names=T)
```

make plots of these networks in cytoscape.

## also save the list of cluster/domain specific or near-specific TFs from the pseudobulk-genes-prefiltered-GRN.
```{r}
write.table(rnetspectfs$nmp_specTFs,"processed-data/12_DEanalyses_removedsampsAndFinalNMseg/12h1-TFs_withOver80Pct_NMpos_spec_edges_inPbulkPrefiltGRN.txt",sep='\t',quote=F,row.names=F,col.names=F)
write.table(rnetspectfs$nmn_specTFs,"processed-data/12_DEanalyses_removedsampsAndFinalNMseg/12h2-TFs_withOver80Pct_NMneg_spec_edges_inPbulkPrefiltGRN.txt",sep='\t',quote=F,row.names=F,col.names=F)
## also save the list of all TFs that are in the network, i.e. for use as a background gene set if doing enrichment testing etc
write.table(unique(rnets$filt$TF),"processed-data/12_DEanalyses_removedsampsAndFinalNMseg/12h3-AllTFs_in_pbulkPrefiltGRN.txt",sep='\t',quote=F,row.names=F,col.names=F)
```

seshinf
```{r}
sessionInfo()
sessioninfo::session_info()
```
R version 4.4.3 (2025-02-28)
Platform: aarch64-apple-darwin20
Running under: macOS Sequoia 15.3.2

Matrix products: default
BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats     graphics  grDevices utils    
[5] methods   base     

other attached packages:
[1] Matrix_1.7-3        BiocParallel_1.40.0
[3] parallelly_1.43.0   colorout_1.3-0.2   
[5] gridExtra_2.3       ggtext_0.1.2       
[7] ggplot2_3.5.2       data.table_1.17.4  
[9] rlang_1.1.5        

loaded via a namespace (and not attached):
 [1] gtable_0.3.6         xfun_0.52           
 [3] targeted_0.5         lattice_0.22-6      
 [5] numDeriv_2016.8-1.1  SCORPION_1.0.2      
 [7] vctrs_0.6.5          tools_4.4.3         
 [9] generics_0.1.4       parallel_4.4.3      
[11] tibble_3.2.1         pkgconfig_2.0.3     
[13] RColorBrewer_1.1-3   optimx_2024-12.2    
[15] lifecycle_1.0.4      compiler_4.4.3      
[17] farver_2.1.2         stringr_1.5.1       
[19] codetools_0.2-20     litedown_0.6        
[21] pracma_2.4.4         pillar_1.10.2       
[23] nloptr_2.2.1         lava_1.8.1          
[25] commonmark_1.9.5     tidyselect_1.2.1    
[27] digest_0.6.37        stringi_1.8.7       
[29] future_1.40.0        dplyr_1.1.4         
[31] listenv_0.9.1        labeling_0.4.3      
[33] splines_4.4.3        rprojroot_2.0.4     
[35] grid_4.4.3           here_1.0.1          
[37] cli_3.6.4            magrittr_2.0.3      
[39] dichromat_2.0-0.1    survival_3.8-3      
[41] future.apply_1.11.3  withr_3.0.2         
[43] scales_1.4.0         lambda.r_1.2.4      
[45] globals_0.17.0       igraph_2.1.4        
[47] RANN_2.6.2           futile.logger_1.4.3 
[49] pbapply_1.7-2        evaluate_1.0.3      
[51] knitr_1.50           irlba_2.3.5.1       
[53] markdown_2.0         futile.options_1.0.1
[55] gridtext_0.1.5       Rcpp_1.0.14         
[57] glue_1.8.0           formatR_1.14        
[59] xml2_1.3.8           R6_2.6.1            
> sessioninfo::session_info()
─ Session info ──────────────────────────────
 setting  value
 version  R version 4.4.3 (2025-02-28)
 os       macOS Sequoia 15.3.2
 system   aarch64, darwin20
 ui       X11
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       America/Chicago
 date     2025-09-01
 pandoc   NA
 quarto   1.7.32 @ /Applications/Positron.app/Contents/Resources/app/quarto/bin/quarto

─ Packages ──────────────────────────────────
 !  package        * version    date (UTC) lib source
    BiocParallel   * 1.40.0     2024-11-23 [1] Bioconductor 3.20 (R 4.4.2)
 VP cli              3.6.4      2025-04-23 [2] CRAN (R 4.4.1) (on disk 3.6.5)
    codetools        0.2-20     2024-03-31 [1] CRAN (R 4.4.3)
    colorout       * 1.3-0.2    2024-05-01 [1] Github (jalvesaq/colorout@c6113a2)
    commonmark       1.9.5      2025-03-17 [1] CRAN (R 4.4.1)
    data.table     * 1.17.4     2025-05-26 [1] CRAN (R 4.4.3)
    dichromat        2.0-0.1    2022-05-02 [1] CRAN (R 4.4.0)
    digest           0.6.37     2024-08-19 [1] CRAN (R 4.4.1)
    dplyr            1.1.4      2023-11-17 [1] CRAN (R 4.4.0)
    evaluate         1.0.3      2025-01-10 [1] CRAN (R 4.4.1)
    farver           2.1.2      2024-05-13 [1] CRAN (R 4.4.0)
    formatR          1.14       2023-01-17 [1] CRAN (R 4.4.0)
    futile.logger    1.4.3      2016-07-10 [1] CRAN (R 4.4.0)
    futile.options   1.0.1      2018-04-20 [1] CRAN (R 4.4.0)
    future           1.40.0     2025-04-10 [1] CRAN (R 4.4.1)
    future.apply     1.11.3     2024-10-27 [1] CRAN (R 4.4.1)
    generics         0.1.4      2025-05-09 [1] CRAN (R 4.4.1)
    ggplot2        * 3.5.2      2025-04-09 [1] CRAN (R 4.4.1)
    ggtext         * 0.1.2      2022-09-16 [1] CRAN (R 4.4.0)
    globals          0.17.0     2025-04-16 [1] CRAN (R 4.4.1)
    glue             1.8.0      2024-09-30 [1] CRAN (R 4.4.1)
    gridExtra      * 2.3        2017-09-09 [1] CRAN (R 4.4.0)
    gridtext         0.1.5      2022-09-16 [1] CRAN (R 4.4.0)
    gtable           0.3.6      2024-10-25 [1] CRAN (R 4.4.1)
    here             1.0.1      2020-12-13 [1] CRAN (R 4.4.0)
    igraph           2.1.4      2025-01-23 [1] CRAN (R 4.4.1)
    irlba            2.3.5.1    2022-10-03 [1] CRAN (R 4.4.0)
    knitr            1.50       2025-03-16 [1] CRAN (R 4.4.2)
    labeling         0.4.3      2023-08-29 [1] CRAN (R 4.4.0)
    lambda.r         1.2.4      2019-09-18 [1] CRAN (R 4.4.0)
    lattice          0.22-6     2024-03-20 [1] CRAN (R 4.4.3)
    lava             1.8.1      2025-01-12 [1] CRAN (R 4.4.1)
    lifecycle        1.0.4      2023-11-07 [1] CRAN (R 4.4.0)
    listenv          0.9.1      2024-01-29 [1] CRAN (R 4.4.0)
    litedown         0.6        2025-02-27 [1] CRAN (R 4.4.3)
    magrittr         2.0.3      2022-03-30 [1] CRAN (R 4.4.0)
    markdown         2.0        2025-03-23 [1] CRAN (R 4.4.3)
    Matrix         * 1.7-3      2025-03-11 [1] CRAN (R 4.4.1)
    nloptr           2.2.1      2025-03-17 [1] CRAN (R 4.4.1)
    numDeriv         2016.8-1.1 2019-06-06 [1] CRAN (R 4.4.0)
    optimx           2024-12.2  2024-12-10 [1] CRAN (R 4.4.1)
    parallelly     * 1.43.0     2025-03-24 [1] CRAN (R 4.4.1)
    pbapply          1.7-2      2023-06-27 [1] CRAN (R 4.4.0)
    pillar           1.10.2     2025-04-05 [1] CRAN (R 4.4.1)
    pkgconfig        2.0.3      2019-09-22 [1] CRAN (R 4.4.0)
    pracma           2.4.4      2023-11-10 [1] CRAN (R 4.4.0)
    R6               2.6.1      2025-02-15 [1] CRAN (R 4.4.1)
    RANN             2.6.2      2024-08-25 [1] CRAN (R 4.4.1)
    RColorBrewer     1.1-3      2022-04-03 [1] CRAN (R 4.4.0)
    Rcpp             1.0.14     2025-01-12 [1] CRAN (R 4.4.1)
 VP rlang          * 1.1.5      2025-04-11 [2] CRAN (R 4.4.1) (on disk 1.1.6)
    rprojroot        2.0.4      2023-11-05 [1] CRAN (R 4.4.0)
    scales           1.4.0      2025-04-24 [1] CRAN (R 4.4.1)
    SCORPION         1.0.2      2024-05-29 [1] CRAN (R 4.4.0)
    sessioninfo      1.2.3      2025-02-05 [1] CRAN (R 4.4.1)
    stringi          1.8.7      2025-03-27 [1] CRAN (R 4.4.1)
    stringr          1.5.1      2023-11-14 [1] CRAN (R 4.4.0)
    survival         3.8-3      2024-12-17 [1] CRAN (R 4.4.3)
    targeted         0.5        2024-02-22 [1] CRAN (R 4.4.0)
    tibble           3.2.1      2023-03-20 [1] CRAN (R 4.4.0)
    tidyselect       1.2.1      2024-03-11 [1] CRAN (R 4.4.0)
    vctrs            0.6.5      2023-12-01 [1] CRAN (R 4.4.0)
    withr            3.0.2      2024-10-28 [1] CRAN (R 4.4.1)
    xfun             0.52       2025-04-02 [1] CRAN (R 4.4.1)
    xml2             1.3.8      2025-03-14 [1] CRAN (R 4.4.1)

 [1] /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library
 [2] /Users/bmulvey/Library/R/arm64/4.4/library

 * ── Packages attached to the search path.
 V ── Loaded and on-disk version mismatch.
 P ── Loaded and on-disk path mismatch.

─────────────────────────────────────────────
