---
title: "09-AD_PD_Genes_GSEA_MulticlustDEnoMixClusts_LCNMde_LCNMF"
author: "Bernie Mulvey"
date: "2025-07-20"
output: html_document
---
```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
knitr::opts_chunk$set(fig.width=7,fig.height=10)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(clusterProfiler) # otherwise fgsea parallelization doesnt seem to work
library(fgsea)

require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")

## change write.table to output a TSV without quotes or rownames by default
library(default)
default(write.table) <- list(row.names=F,col.names=T,sep='\t',quote=F)

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc
library(parallel)
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
library(parallelly)
library(BiocParallel)
options(bphost="localhost")
```

### Opentargets, Bellenguez gene set retrievals
```{r}
ots <- readRDS("raw-data/ref_data/OpenTargets_AD_PD/OpenTargs_AD_PD_min1_and_min2_evidencetype_genesets.RDS")
ots <- lapply(ots,function(x){x$symbol})

bellen <- fread("raw-data/ref_data/ADGWAS_Bellenguez22_ST5_ST20_ST24-27.txt")
# not all supp tabs had ensgs so symbols here as well
bellens <- split(bellen$symbol,bellen$method) # gene prioritization approach
bellens$allGenes <- unique(bellen$symbol)
bellens$allExceptNearestGene <- bellen[method!="NearestGene",symbol]
names(bellens) <- paste0("Bellenguez22_",names(bellens))

disgs <- c(ots,bellens)

rm(ots,bellen,bellens)
```

PART 1: get signed DE t stat vectors per cluster per test
```{r}
de2b <- readRDS("processed-data/12_DEanalyses_removedsampsAndFinalNMseg/02b-voomLmFit_objs_and_DE_tables_LabSex_LabE2vE4_LabSingleGenos_LabAnces_LabAncesE4E2_noMixClusts_YRIcontAndCat_JUL2025.RDS")

## we want continuous ancestry analyses, except for the ancestry-strat analysis
de2b2 <- list(sexlabel=de2b$cont_ances$sexlabel$detabs,E2E4label=de2b$cont_ances$E2E4label$detabs,ApoAllelesLabel=de2b$cont_ances$ApoAllelesLabel$detabs)
de2b2[[length(de2b2)+1]] <- de2b$cat_ances$AncesByLabel$detabs
names(de2b2)[length(de2b2)] <- "AncesByLabel"

de2b3 <- list()
i<-1
for (i in c(1:length(de2b2))){
    j<-1
    for (j in c(1:length(de2b2[[i]]))){
        de2b3[length(de2b3)+1] <- de2b2[[i]][j]
        names(de2b3)[length(de2b3)] <- names(de2b2[[i]])[j]
    }
    rm(j)
}
rm(i)

### drop sex chr genes from sex DE tests
de2b3[grep(names(de2b3),pattern="Sex",value=T)] <- lapply(de2b3[grep(names(de2b3),pattern="Sex",value=T)],FUN=function(x){
    x[!(chr %in% grep(chr,pattern="chrX|chrY",value=T))]})

### drop mito genes from all tests
de2b3 <- lapply(de2b3,FUN=function(x){
    x[!(chr %in% grep(chr,pattern="chrMT",value=T))]})

### get named, SIGNED vectors of DE t-stats from each test
### need to use gene symbols for compatibility with the TF-target sets
deres <- list()
i<-1
for (i in c(1:length(de2b3))){
    setnames(de2b3[[i]],"t","tstat")
    tmp <- copy(de2b3[[i]])[,.(gene_name,tstat)]
    
    dropg <- tmp[,.N,by="gene_name"][N>1,gene_name]
    tmp <- tmp[!(gene_name %in% dropg)]
    
    setorderv(tmp,"tstat",-1)
    ## get the stat column as a vector and give it the gene ids as names for fgsea
    ## note that since data.table (invisibly) uses list() for column data, its cleaner to just make the working table a data frame for this last bit
    tmp <- as.data.frame(tmp)
    v <- tmp$tstat
    names(v) <- tmp$gene_name
    deres[[length(deres)+1]] <- v
    names(deres)[length(deres)] <- names(de2b3)[i]
    rm(v,tmp)
}
rm(i,de2b,de2b2,dropg)
gc(full=T)
```


## add NM DE
```{r}
lcnmde <- fread("processed-data/12_DEanalyses_removedsampsAndFinalNMseg/04-LCNMpos_vs_LCNMneg_DE.txt")
# drop mito genes
lcnmde <- lcnmde[!(chr %in% "chrMT")]

# add to DE tabs list we return to for unsigned tests
de2b3$LCNMposVneg <- lcnmde

# add to signed vectors list
setnames(lcnmde,"t","tstat")
setorderv(lcnmde,"tstat",-1)
v <- lcnmde$tstat
names(v) <- lcnmde$gene_name

deres$LCNMposVneg <- v

rm(lcnmde,v)
```

## get NMFs

## load the NMF results from LC spots; identify factors with relatively factor-specific gene loadings for many genes
```{r}
# get gene metadata
lc3 <- readRDS("processed-data/06-countsOnly_noImgData_QCed_SPE_split_to_tissSections.RDS")
rddt <- as.data.table(rowData(lc3)) 
rm(lc3)
gc(full=T)


### now we can load and tackle the nmf results
lc.nmf2 <- readRDS("processed-data/10_subclustering/07-lcnmf160_tol1e-9.RDS")
lc.nmffilt <- readRDS("processed-data/10_subclustering/07b-lcnmf160_tol1e-9_rowSumLogctFilt18.RDS")

keepfacts <- fread("processed-data/12_DEanalyses_removedsampsAndFinalNMseg/06-LCNMF_factors_and_factorSpecGenes_min25specGenes.txt")
keepfactsfilt <- fread("processed-data/12_DEanalyses_removedsampsAndFinalNMseg/06b-LCNMFLogCt18Filt_factors_and_factorSpecGenes_min25specGenes.txt")

w2 <- as.data.table(lc.nmf2$w,keep.rownames=T)
keepn <- c("rn",unique(keepfacts$factor))
w2 <- w2[,..keepn]

w2filt <- as.data.table(lc.nmffilt$w,keep.rownames=T)
keepnfilt <- c("rn",unique(keepfactsfilt$factor))
w2filt <- w2filt[,..keepnfilt]

rm(lc.nmf2,lc.nmffilt,keepn,keepnfilt,keepfacts,keepfactsfilt)
# append gene symbols

w2 <- merge.data.table(w2,rddt[,.(gene_id,gene_name)],by.x="rn",by.y="gene_id")
nameord <- c("rn","gene_name",names(w2)[!(names(w2) %in% c("rn","gene_name"))])
w2 <- w2[,..nameord]
setnames(w2,"rn","gene_id")

w2filt <- merge.data.table(w2filt,rddt[,.(gene_id,gene_name)],by.x="rn",by.y="gene_id")
nameordfilt <- c("rn","gene_name",names(w2filt)[!(names(w2filt) %in% c("rn","gene_name"))])
w2filt <- w2filt[,..nameordfilt]
setnames(w2filt,"rn","gene_id")

## only need to run one-sided GSEA (positive enrichment) on these using the full set of loadings for that factor to identify any pathways etc that are enriched in that factor's genes. the enrichment analyses, by nature of GSEA, will be weighted toward the genes with the highest loadings, and our pre-selection of factors here has ensured that these factors have relatively unique and strong loadings for numerous genes.

# drop duplicated genes and chrMT genes for running fgsea
keepg <- w2[,.N,by="gene_name"][N==1,gene_name]
keepi <- w2[,.N,by="gene_id"][N==1,gene_id]
dropm <- rddt[chr=="chrMT",gene_name]
dropmi <- rddt[chr=="chrMT",gene_id]
w2b <- w2[gene_name %in% keepg&gene_id %in% keepi&!(gene_name %in% dropm) & !(gene_id %in% dropmi)]
w2filtb <- w2filt[gene_name %in% keepg & gene_id %in% keepi & !(gene_name %in% dropm) & !(gene_id %in% dropmi)]

## get loadings in descending order for each factor of interest, name with gene ids for msigdb or with gene symbols for TF-target testing
unfiltnmfs <- lapply(names(w2b)[3:ncol(w2b)],function(k){
    setorderv(w2b,cols = k,-1)
   
    # get the descending order loading vector, clone it to name by gene id or symb
    v <- unlist(w2b[!is.na(k),..k])
    names(v) <- w2b[!is.na(k),gene_name]
    return(v)
})
names(unfiltnmfs) <- paste0(names(w2b)[3:ncol(w2b)],"_unfilt")

## same for filtered
filtnmfs <- lapply(names(w2filtb)[3:ncol(w2filtb)],function(k){
    setorderv(w2filtb,cols = k,-1)
   
    # get the descending order loading vector, clone it to name by gene id or symb
    v <- unlist(w2filtb[!is.na(k),..k])
    names(v) <- w2filtb[!is.na(k),gene_name]
    return(v)
})
names(filtnmfs) <- paste0(names(w2filtb)[3:ncol(w2filtb)],"_filt")

### append the NMFs to the signed DE vectors list
deres <- c(deres,unfiltnmfs,filtnmfs)

### clean up before GSEA runs
rm(w2,w2b,w2filt,w2filtb,rddt,keepg,keepi,nameord,nameordfilt,dropm,dropmi,filtnmfs,unfiltnmfs)
gc(full=T)
```

### run fgsea-signed tests
### looping through each cluster-variable interaction (each run is very fast with 10 cpus in biocparallel, so just serially run 10cpu GSEA for each cluster)
### increase maxsize to 1000 to accomodate all disease gene sets (largest 779)
```{r}
gseares <- mapply(X=deres,Y=names(deres),SIMPLIFY=FALSE,FUN=function(X,Y){
  register(MulticoreParam())
   # if the test is an NMF, we only run one direction (positive) since the NMFs are already signed
   # get cond1-up enriched results
   z1<-fgseaMultilevel(pathways=disgs,stats = X,minSize = 15,maxSize = 1000,eps=0.0,nPermSimple = 50000,nproc=10,scoreType = "pos")
   # coonvert leadingedge to one long string (it's returned as a list which is not compatible with data.table)
   z1$leadingEdge <- as.character(z1$leadingEdge)
   z1$leadingEdge <- gsub(z1$leadingEdge,pattern="^c\\((.*)\\)$",replacement="\\1")
   z1$leadingEdge <- gsub(z1$leadingEdge,pattern='"',replacement='')
   
   # drop newlines from leadingEdge
   z1$leadingEdge <- gsub(z1$leadingEdge,pattern=", \n",replacement=", ")
   # somehow, one run of this sometimes doesnt get them all so repeat for good meas
   z1$leadingEdge <- gsub(z1$leadingEdge,pattern=", \n",replacement=", ")
   
   z1 <- as.data.table(z1)
   z1[,test:=Y]
   
   if(length(grep(Y,pattern="Sex",value=T))>0){
       z1[,dir:="male_up"]
   } else if(length(grep(Y,pattern="E4vE2",value=T))>0){
       z1[,dir:="E4carriers_up"]
   } else if(length(grep(Y,pattern="YRI",value=T))>0){
       z1[,dir:="YRI_up"]
   } else if(length(grep(Y,pattern="nmf",value=T))>0) {
       z1[,dir:="nmf_factor_enriched"]
   } else {
       z1[,dir:=gsub(Y,pattern="^.*_(E....)_vs_(.*)",replacement=paste0("\\1","_up_vs_","\\2"))]
   }
   
   # get condition 2-up (e.g., female-up) enriched results; not necess for NMFs
   if (length(grep(Y,pattern="nmf",value=T))>0){
       z2 <- copy(z1[1,])
       z2[,dir:="dummy"]
   } else {
       register(MulticoreParam())
       z2<-fgseaMultilevel(pathways=disgs,stats = X,minSize = 15,maxSize = 1000,eps=0.0,nPermSimple = 50000,nproc=10,scoreType = "neg")
       # coonvert leadingedge to one long string (it's returned as a list which is not compatible with data.table)
       z2$leadingEdge <- as.character(z2$leadingEdge)
       z2$leadingEdge <- gsub(z2$leadingEdge,pattern="^c\\((.*)\\)$",replacement="\\1")
       z2$leadingEdge <- gsub(z2$leadingEdge,pattern='"',replacement='')
       
       # drop newlines from leadingEdge
       z2$leadingEdge <- gsub(z2$leadingEdge,pattern=", \n",replacement=", ")
       # somehow, one run of this sometimes doesnt get them all so repeat for good meas
       z2$leadingEdge <- gsub(z2$leadingEdge,pattern=", \n",replacement=", ")
       
       z2 <- as.data.table(z2)
       z2[,test:=Y]
       
        if(length(grep(Y,pattern="Sex",value=T))>0){
           z2[,dir:="female_up"]
       } else if(length(grep(Y,pattern="E4vE2",value=T))>0){
           z2[,dir:="E4carriers_down"]
       } else if(length(grep(Y,pattern="YRI",value=T))>0){
           z2[,dir:="YRI_down"]
       } else {
           z2[,dir:=gsub(Y,pattern="^.*_(E....)_vs_(.*)",replacement=paste0("\\1","_down_vs_","\\2"))]
       }
   }

   z <- as.data.table(rbind(z1,z2))
   z <- z[dir!="dummy"] # remove results from a placeholder output table for NMF cases
   return(z)
})
names(gseares) <- names(deres)

saveRDS(gseares,"processed-data/12_DEanalyses_removedsampsAndFinalNMseg/09_AD_PD_GSEA_MulticlustNoMixClustsDE_NMposnegDE_LCNMFs.RDS")

rm(deres,gseares)
```


### PART 2: get UNsigned DE t stat vectors per cluster per test
```{r}
### get named, UNsigned vectors of DE t-stats from each test
deres <- list()
i<-1
for (i in c(1:length(de2b3))){
    tmp <- copy(de2b3[[i]])[,.(gene_name,abs(tstat))]
    setnames(tmp,2,"tstat")
    setorderv(tmp,"tstat",-1)
    ## get the stat column as a vector and give it the gene ids as names for fgsea
    ## note that since data.table (invisibly) uses list() for column data, its cleaner to just make the working table a data frame for this last bit
    tmp <- as.data.frame(tmp)
    v <- tmp$tstat
    names(v) <- tmp$gene_name
    deres[[length(deres)+1]] <- v
    names(deres)[length(deres)] <- names(de2b2)[i]
    rm(v,tmp)
}
rm(i,de2b2)
```

run UNSIGNED fgsea (genes that tend to be affected, regardless of direction)
### increase maxsize to 1000 to accomodate all disease gene sets
```{r}
gseares.unsign <- mapply(X=deres,Y=names(deres),SIMPLIFY=FALSE,FUN=function(X,Y){
   register(MulticoreParam())
   
   # get DE-enriched results
   z1<-fgseaMultilevel(pathways=disgs,stats = X,minSize = 15,maxSize = 1000,eps=0.0,nPermSimple = 50000,nproc=10,scoreType = "pos")
   
   # coonvert leadingedge to one long string (it's returned as a list which is not compatible with data.table)
   z1$leadingEdge <- as.character(z1$leadingEdge)
   z1$leadingEdge <- gsub(z1$leadingEdge,pattern="^c\\((.*)\\)$",replacement="\\1")
   z1$leadingEdge <- gsub(z1$leadingEdge,pattern='"',replacement='')
   # drop newlines from leadingEdge
   z1$leadingEdge <- gsub(z1$leadingEdge,pattern=", \n",replacement=", ")
   # belt and suspenders
   z1$leadingEdge <- gsub(z1$leadingEdge,pattern=", \n",replacement=", ")
   
   z1 <- as.data.table(z1)
   z1[,test:=Y]
   z1[,dir:="either"]
   
   return(z1)
})

names(gseares.unsign) <- names(deres)

saveRDS(gseares.unsign,"processed-data/12_DEanalyses_removedsampsAndFinalNMseg/09_AD_PD_GSEA_MulticlustNoMixClustsDE_NMposnegDE_unsigned.RDS")
```

rep inf
```{r}
sessionInfo()
sessioninfo::session_info()
```
