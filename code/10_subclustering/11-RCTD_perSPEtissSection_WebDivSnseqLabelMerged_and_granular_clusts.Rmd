---
title: "11-RCTD_perSPEtissSection_WebDivSnseqLabelMerged_and_granular_clusts"
author: "Bernie Mulvey"
date: "2025-06-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(SpatialExperiment)
library(SingleCellExperiment)
# devtools::install_github("dmcable/spacexr", build_vignettes = FALSE, force = TRUE)
library(spacexr) # Bioc 3.21 version is a fork of the github version without some of the functionality yet incorporated, so using github ver per above command commented out
library(SummarizedExperiment)
library(WeberDivechaLCdata)
# library(SpatialFeatureExperiment)

## rstudio GUI tweaks
require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")
##

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc. seemed to need this a couple times, but otherwise havent so its here as a preventative measure. part of this is adding the line 
# OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
# to Renviron.site. see e.g. top response on https://stackoverflow.com/questions/73638290/python-on-mac-is-it-safe-to-set-objc-disable-initialize-fork-safety-yes-globall 
library(parallelly)
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost="localhost")
```

## load SPE (we need untransformed counts) and its annots
## load pre-annotated webdiv snseq 
```{r}
lc3 <- readRDS("processed-data/06-countsOnly_noImgData_QCed_SPE_split_to_tissSections.RDS")

## drop samples with uncertain anatomy
lc3 <- lc3[,!(lc3$brnum %in% paste0("Br",c(5517,5276,5712)))]

louvs <- readRDS("processed-data/07_featureSelection_dimred_harmony_clustering/04-Initial_louvLeid_res0.5-1-2_clusterings.RDS")
anno <- fread("processed-data/08_validitycheck_25hdg75svg_louv1/10-25hdg75svg_louv1_annots.txt")
louvs <- louvs$HARMONYlmbna_HDG_SVG_2575[,.(rn,snnHARMONYlmbna_HDG_SVG_2575_louv_res1)]
setnames(louvs,2,"clusid")
louvs <- merge.data.table(louvs,anno[,.(clusid,anno)],by="clusid")
lc3$cell_type <- DataFrame(louvs,row.names=louvs$rn)[colnames(lc3),"anno"]
lc3$cell_type <- as.factor(lc3$cell_type)
rm(louvs,anno)

#######
lcsn <- WeberDivechaLCdata_singleNucleus()

## determine what hierarchical clustering levels there are
tmpcd <- as.data.table(colData(lcsn),keep.rownames=T)
checklabs <- unique(tmpcd[,.(label,label_merged,label_inhibitory)])
## so the inhibitories are re-clusterings (multiple label_inhibitory per label)
View(checklabs[label_merged!="inhibitory"])
## the other 23 labels (of 30) have single label merged assignments.
## so we will make a cluster hierarchy as follows: cluster_merged > label > label or inhibitory subcluster

# to ensure there's enough LCNE cells for RCTD to work with, change label_merged and then label itself to NE for any cell classified as supervised NE OR unsup. NE
tmpcd[,label_merged:=as.character(label_merged)]
tmpcd[unsupervised_NE==TRUE,label_merged:="NE"]
tmpcd[supervised_NE==TRUE,label_merged:="NE"]

## then, make label a character column of merged_label (parent) and label (granular clust #)
tmpcd[,label:=as.character(label)]
tmpcd[,label:=paste0(label_merged,"_",label)]
## for NE neurons, disregard the granular cluster of origin since we're integrating several definition types now
tmpcd[label_merged=="NE",label:="NE"]
## finally, add info about inhibitory subcluster; ONLY for inhibitory merged clusters
tmpcd[,sublabel:=label]
tmpcd[label_merged=="inhibitory"&!is.na(label_inhibitory),sublabel:=paste0(sublabel,
                                                "_sub",label_inhibitory)]
## for sublabels, we will need to filter out sublabels with fewer than RCTD's suggested minimum of 25 cells (see loop below).

stopifnot(length(unique(tmpcd$label))>length(unique(tmpcd$label_merged)))
stopifnot(length(unique(tmpcd$sublabel))>length(unique(tmpcd$label)))

colData(lcsn) <- DataFrame(tmpcd,row.names=tmpcd$rn)[colnames(lcsn),]

rm(tmpcd,checklabs)
```

going by the bioc RCTD vignette; iterate thru each cluster level per spatial sample
```{r}
cluslevs <- c("label_merged","label","sublabel")

## iterate over cluster types to prevent data loss if errors partway
rctdresults <- list()
i <- 1
for (i in c(1:length(cluslevs))){
  cluslev <- cluslevs[i]
  setDTthreads(1,restore_after_fork=FALSE) # prevent resource overcommitting while running RCTD steps
  
  ## check, remove any cells for which there are fewer than 25 cells for the current label set
  checkcts <- as.data.table(table(as.character(colData(lcsn)[,cluslev])))
  
  if(nrow(checkcts[N<25])>0){
    checkcts <- checkcts[N>=25]
    tmplcsn <- lcsn[,colData(lcsn)[,cluslev] %in% checkcts$V1]
    cts <- colData(tmplcsn)[,cluslev]
    names(cts) <- rownames(colData(tmplcsn))
    cts <- as.factor(cts)
  } else {
    tmplcsn <- lcsn
    cts <- colData(lcsn)[,cluslev]
    names(cts) <- rownames(colData(lcsn))
    cts <- as.factor(cts)
  }
  rm(checkcts)
  
  stopifnot(all(names(cts)==colnames(counts(tmplcsn))))
  
  # convert snseq ref to an RCTD Reference class
  # theres 12k of one merged label type i guess so raise the max limit to accomodate
  reflcsn <- spacexr::Reference(counts=counts(tmplcsn),cell_types=cts,n_max_cells=15000)
  
  # create RCTD, run rctd per visium sample
  
  samps <- unique(lc3$sample_id)
  rctdsampres <- lapply(X=samps,FUN=function(s){
      setDTthreads(1,restore_after_fork=FALSE) # make certain of preventing resource overcommitting while running RCTD steps by also embedding this in apply steps
      ## make an RCTD spatialrna class object for input
      lccoord <- as.data.frame(spatialCoords(lc3[,lc3$sample_id==s]))
      colnames(lccoord) <- c("x","y")
      lc3sxr <- spacexr::SpatialRNA(coords=lccoord,counts = counts(lc3[,lc3$sample_id==s]))

      # include low count spots, because they are frequent; do not penalize for treating spots as multitype ("double_threshold") because they pretty obviously are; counts_min is default and shown for posterity
      rctd_data <- create.RCTD(spatialRNA = lc3sxr,
                           reference = reflcsn,
                           max_cores = 10,
                           UMI_max = Inf,
                           UMI_min=50,
                           MAX_MULTI_TYPES = 4,
                           DOUBLET_THRESHOLD = 0,
                           counts_MIN = 10,
                           keep_reference = TRUE)
  
      # run RCTD multi, allowing up to 4 types per spot
      lc.rctd <- run.RCTD(rctd_data,doublet_mode = "multi")
  
      # extract the spotwise RCTD results and their corresponding spot IDs to a table; save
      wat <- lc.rctd@results
      spotnames <- colnames(lc.rctd@spatialRNA@counts)
  
      
      setDTthreads(10,restore_after_fork=FALSE) # multithread for this part
      #tabulate spotwise results:
      rctdrestab <- mapply(x=wat,n=spotnames,SIMPLIFY=FALSE,function(x,n){
          setDTthreads(10,restore_after_fork=FALSE) # multithread for this part
          y <- as.data.table(t(x$all_weights))
          setnames(y,"5HT","x5HT",skip_absent=TRUE)
      
          # change sub_weights to match x5HT where applicable
          names(x$sub_weights)[names(x$sub_weights)=="5HT"] <- "x5HT"
      
          z <- copy(y)
          keepn <- names(z)[!(names(z) %in% names(x$sub_weights))]
          z <- z[,..keepn]
          set(z,j = c(1:ncol(z)),value=0)
          z <- as.data.table(cbind(z,t(x$sub_weights)))
          setnames(z,names(z),paste0(names(z),"_multi_weight"))
          
          z <- as.data.table(cbind(y,z))
          z[,rn:=n]
          return(z)
      })
      # convert the spotwise tables (1 row by many columns) to one table with a row per spot
      rctdrestab <- rbindlist(rctdrestab,fill=T)
      return(rctdrestab)
  })
  # make sure sample_id is passed to the corresponding sample's results (one sample = one list entry with a single data.table; we can rbindlist the samplewise results to make a single table to join into the SPE colData when we want to use the results.)
  names(rctdsampres) <- samps
  
  # return results to output-holding list
  
  rctdresults[[i]] <- rctdsampres
  names(rctdresults)[i] <- cluslevs[i]
  
  rm(cts,reflcsn,rctdsampres,tmplcsn)
}

names(rctdresults) <- cluslevs
```

```{r}
### gah, didn't label the first set of columns in each output table as [label]_full_weights. append that to make clear what those columns are for later:
rctdresults <- lapply(rctdresults,function(x){
  z <- lapply(x,function(y){
    fixnames <- names(y)[!(names(y) %in% c("rn",grep(names(y),pattern="multi_weight",value=T)))]
    setnames(y,fixnames,paste0(fixnames,"_full_weights"))
    return(y)
  })
  return(z)
})

rctdconcat <- lapply(rctdresults,rbindlist,idcol="sample_id",fill=T)
rctdconcat <- lapply(rctdconcat,function(x){
  nameord <- c("rn",
               "sample_id",
               grep(names(x),pattern="full_we",value=T),
               grep(names(x),pattern="multi_we",value=T))
  # drop weird glitchy noncluster results that have all NAs--showed up only in some samples
  nameord <- grep(nameord,pattern="V1",value=T,invert =T)
  # reorder columns
  y <- x[,..nameord]
  return(y) 
})
# and save
saveRDS(rctdresults,"processed-data/10_subclustering/11-RCTDmulti4_webdivLabel-LabMerge-LabWithInhibSubclusts_samplewise_results.RDS")
saveRDS(rctdconcat,"processed-data/10_subclustering/11-RCTDmulti4_webdivLabel-LabelMerged-LabelWithInhibSubclusts_concatresults.RDS")
```

repinf
```{r}
sessionInfo()
sessioninfo::session_info()
```
R version 4.4.3 (2025-02-28)
Platform: aarch64-apple-darwin20
Running under: macOS Sequoia 15.3.2

Matrix products: default
BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats4    stats     graphics  grDevices utils     datasets  methods   base     

other attached packages:
 [1] BiocParallel_1.40.0         parallelly_1.43.0           colorout_1.3-0.2           
 [4] WeberDivechaLCdata_1.8.0    ExperimentHub_2.14.0        AnnotationHub_3.14.0       
 [7] BiocFileCache_2.14.0        dbplyr_2.5.0                spacexr_2.2.1              
[10] SpatialExperiment_1.16.0    SingleCellExperiment_1.28.1 SummarizedExperiment_1.36.0
[13] Biobase_2.66.0              GenomicRanges_1.58.0        GenomeInfoDb_1.42.3        
[16] IRanges_2.40.1              S4Vectors_0.44.0            BiocGenerics_0.52.0        
[19] MatrixGenerics_1.18.1       matrixStats_1.5.0           data.table_1.17.4          
[22] rlang_1.1.5                

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.1        dplyr_1.1.4             blob_1.2.4             
 [4] filelock_1.0.3          Biostrings_2.74.1       fastmap_1.2.0          
 [7] digest_0.6.37           mime_0.13               lifecycle_1.0.4        
[10] KEGGREST_1.46.0         RSQLite_2.3.9           magrittr_2.0.3         
[13] compiler_4.4.3          tools_4.4.3             yaml_2.3.10            
[16] knitr_1.50              S4Arrays_1.6.0          bit_4.6.0              
[19] curl_6.2.2              here_1.0.1              DelayedArray_0.32.0    
[22] abind_1.4-8             withr_3.0.2             purrr_1.0.4            
[25] grid_4.4.3              iterators_1.0.14        cli_3.6.4              
[28] rmarkdown_2.29          crayon_1.5.3            generics_0.1.4         
[31] rstudioapi_0.17.1       httr_1.4.7              rjson_0.2.23           
[34] DBI_1.2.3               cachem_1.1.0            zlibbioc_1.52.0        
[37] parallel_4.4.3          AnnotationDbi_1.68.0    BiocManager_1.30.25    
[40] XVector_0.46.0          vctrs_0.6.5             Matrix_1.7-3           
[43] jsonlite_2.0.0          bit64_4.6.0-1           magick_2.8.6           
[46] foreach_1.5.2           glue_1.8.0              codetools_0.2-20       
[49] BiocVersion_3.20.0      quadprog_1.5-8          UCSC.utils_1.2.0       
[52] tibble_3.2.1            pillar_1.10.2           rappdirs_0.3.3         
[55] htmltools_0.5.8.1       GenomeInfoDbData_1.2.13 R6_2.6.1               
[58] doParallel_1.0.17       rprojroot_2.0.4         evaluate_1.0.3         
[61] lattice_0.22-6          png_0.1-8               memoise_2.0.1          
[64] Rcpp_1.0.14             SparseArray_1.6.2       xfun_0.52              
[67] pkgconfig_2.0.3        
> sessioninfo::session_info()
─ Session info ────────────────────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.4.3 (2025-02-28)
 os       macOS Sequoia 15.3.2
 system   aarch64, darwin20
 ui       RStudio
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       America/Chicago
 date     2025-06-05
 rstudio  2024.07.0-daily+219 Cranberry Hibiscus (desktop)
 pandoc   3.1.11 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools/aarch64/ (via rmarkdown)
 quarto   1.4.555 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/quarto

─ Packages ────────────────────────────────────────────────────────────────────────────────
 !  package              * version date (UTC) lib source
    abind                  1.4-8   2024-09-12 [1] CRAN (R 4.4.1)
    AnnotationDbi          1.68.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    AnnotationHub        * 3.14.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    Biobase              * 2.66.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    BiocFileCache        * 2.14.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    BiocGenerics         * 0.52.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    BiocManager            1.30.25 2024-08-28 [1] CRAN (R 4.4.1)
    BiocParallel         * 1.40.0  2024-11-23 [1] Bioconductor 3.20 (R 4.4.2)
    BiocVersion            3.20.0  2024-05-04 [1] Bioconductor 3.20 (R 4.4.0)
    Biostrings             2.74.1  2024-12-16 [1] Bioconductor 3.20 (R 4.4.2)
    bit                    4.6.0   2025-03-06 [1] CRAN (R 4.4.1)
    bit64                  4.6.0-1 2025-01-16 [1] CRAN (R 4.4.1)
    blob                   1.2.4   2023-03-17 [1] CRAN (R 4.4.0)
    cachem                 1.1.0   2024-05-16 [1] CRAN (R 4.4.0)
 VP cli                    3.6.4   2025-04-23 [2] CRAN (R 4.4.1) (on disk 3.6.5)
    codetools              0.2-20  2024-03-31 [1] CRAN (R 4.4.3)
    colorout             * 1.3-0.2 2024-05-01 [1] Github (jalvesaq/colorout@c6113a2)
    crayon                 1.5.3   2024-06-20 [1] CRAN (R 4.4.0)
    curl                   6.2.2   2025-03-24 [1] CRAN (R 4.4.1)
    data.table           * 1.17.4  2025-05-26 [1] CRAN (R 4.4.3)
    DBI                    1.2.3   2024-06-02 [1] CRAN (R 4.4.0)
    dbplyr               * 2.5.0   2024-03-19 [1] CRAN (R 4.4.0)
    DelayedArray           0.32.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    digest                 0.6.37  2024-08-19 [1] CRAN (R 4.4.1)
    doParallel             1.0.17  2022-02-07 [1] CRAN (R 4.4.1)
    dplyr                  1.1.4   2023-11-17 [1] CRAN (R 4.4.0)
    evaluate               1.0.3   2025-01-10 [1] CRAN (R 4.4.1)
    ExperimentHub        * 2.14.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    fastmap                1.2.0   2024-05-15 [1] CRAN (R 4.4.0)
    filelock               1.0.3   2023-12-11 [1] CRAN (R 4.4.0)
    foreach                1.5.2   2022-02-02 [1] CRAN (R 4.4.0)
    generics               0.1.4   2025-05-09 [1] CRAN (R 4.4.1)
    GenomeInfoDb         * 1.42.3  2025-01-27 [1] Bioconductor 3.20 (R 4.4.2)
    GenomeInfoDbData       1.2.13  2024-12-12 [1] Bioconductor
    GenomicRanges        * 1.58.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    glue                   1.8.0   2024-09-30 [1] CRAN (R 4.4.1)
    here                   1.0.1   2020-12-13 [1] CRAN (R 4.4.0)
    htmltools              0.5.8.1 2024-04-04 [1] CRAN (R 4.4.0)
    httr                   1.4.7   2023-08-15 [1] CRAN (R 4.4.0)
    IRanges              * 2.40.1  2024-12-05 [1] Bioconductor 3.20 (R 4.4.2)
    iterators              1.0.14  2022-02-05 [1] CRAN (R 4.4.0)
    jsonlite               2.0.0   2025-03-27 [1] CRAN (R 4.4.1)
    KEGGREST               1.46.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    knitr                  1.50    2025-03-16 [1] CRAN (R 4.4.2)
    lattice                0.22-6  2024-03-20 [1] CRAN (R 4.4.3)
    lifecycle              1.0.4   2023-11-07 [1] CRAN (R 4.4.0)
    magick                 2.8.6   2025-03-23 [1] CRAN (R 4.4.1)
    magrittr               2.0.3   2022-03-30 [1] CRAN (R 4.4.0)
    Matrix                 1.7-3   2025-03-11 [1] CRAN (R 4.4.1)
    MatrixGenerics       * 1.18.1  2025-01-09 [1] Bioconductor 3.20 (R 4.4.2)
    matrixStats          * 1.5.0   2025-01-07 [1] CRAN (R 4.4.1)
    memoise                2.0.1   2021-11-26 [1] CRAN (R 4.4.0)
    mime                   0.13    2025-03-17 [1] CRAN (R 4.4.1)
    parallelly           * 1.43.0  2025-03-24 [1] CRAN (R 4.4.1)
    pillar                 1.10.2  2025-04-05 [1] CRAN (R 4.4.1)
    pkgconfig              2.0.3   2019-09-22 [1] CRAN (R 4.4.0)
    png                    0.1-8   2022-11-29 [1] CRAN (R 4.4.0)
    purrr                  1.0.4   2025-02-05 [1] CRAN (R 4.4.1)
    quadprog               1.5-8   2019-11-20 [1] CRAN (R 4.4.0)
    R6                     2.6.1   2025-02-15 [1] CRAN (R 4.4.1)
    rappdirs               0.3.3   2021-01-31 [1] CRAN (R 4.4.0)
    Rcpp                   1.0.14  2025-01-12 [1] CRAN (R 4.4.1)
    rjson                  0.2.23  2024-09-16 [1] CRAN (R 4.4.1)
 VP rlang                * 1.1.5   2025-04-11 [2] CRAN (R 4.4.1) (on disk 1.1.6)
    rmarkdown              2.29    2024-11-04 [1] CRAN (R 4.4.1)
    rprojroot              2.0.4   2023-11-05 [1] CRAN (R 4.4.0)
    RSQLite                2.3.9   2024-12-03 [1] CRAN (R 4.4.1)
    rstudioapi             0.17.1  2024-10-22 [1] CRAN (R 4.4.1)
    S4Arrays               1.6.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    S4Vectors            * 0.44.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    sessioninfo            1.2.3   2025-02-05 [1] CRAN (R 4.4.1)
    SingleCellExperiment * 1.28.1  2024-11-23 [1] Bioconductor 3.20 (R 4.4.2)
    spacexr              * 2.2.1   2025-06-04 [1] Github (dmcable/spacexr@744153c)
    SparseArray            1.6.2   2025-02-20 [1] Bioconductor 3.20 (R 4.4.2)
    SpatialExperiment    * 1.16.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    SummarizedExperiment * 1.36.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    tibble                 3.2.1   2023-03-20 [1] CRAN (R 4.4.0)
    tidyselect             1.2.1   2024-03-11 [1] CRAN (R 4.4.0)
    UCSC.utils             1.2.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    vctrs                  0.6.5   2023-12-01 [1] CRAN (R 4.4.0)
    WeberDivechaLCdata   * 1.8.0   2024-10-31 [1] Bioconductor 3.20 (R 4.4.1)
    withr                  3.0.2   2024-10-28 [1] CRAN (R 4.4.1)
    xfun                   0.52    2025-04-02 [1] CRAN (R 4.4.1)
    XVector                0.46.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    yaml                   2.3.10  2024-07-26 [1] CRAN (R 4.4.0)
    zlibbioc               1.52.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)

 [1] /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library
 [2] /Users/bmulvey/Library/R/arm64/4.4/library

 * ── Packages attached to the search path.
 V ── Loaded and on-disk version mismatch.
 P ── Loaded and on-disk path mismatch.

───────────────────────────────────────────────────────────────────────────────────────────
