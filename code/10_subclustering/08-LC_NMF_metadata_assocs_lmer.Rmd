---
title: "08-LC_NMF_metadata_assocs_lmer"
author: "Bernie Mulvey"
date: "2025-05-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(lme4)
library(car)

## rstudio GUI tweaks
require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")
##

library(parallel)

## last of all, unload the base package datasets, whose data keep getting in the way of autocompletions (e.g., Theoph is priortized over TRUE)
unloadNamespace("datasets")
```

load nmf, get h matrix; load metadata table
```{r}
lcnmf <- readRDS("processed-data/10_subclustering/07-lcnmf160_tol1e-9.RDS")
h <- as.data.table(t(lcnmf$h),keep.rownames=T)

cd <- fread("processed-data/06-QCed_SPE_splitToTissSect_colData.txt")
cd <- cd[rowname %in% h$rn]
cd <- cd[,.(rowname,sample_id,capture_id,expr_chrM_ratio,APOE,Age,Sex,Rin,Visium_slide,N_NMbodies,Prop_NM,Intensity_NM,brnum,CentroidSignalCount_NM,hemisphere)]

## append YRI estimates
flares <- fread("raw-data/ancestryAndHaplotypes/FLARE/global_ancestry_estimates.txt")
cd[brnum=="Br6119(re-dis)",brnum:="Br6119"] # fix to match flares table

flares <- flares[ID %in% cd$brnum,.(ID,YRI)]
cd <- merge.data.table(cd,flares,by.x="brnum",by.y="ID",all.x=T)
rm(flares)
```

join the spot weights and metadata 
```{r}
mdvars <- names(cd)[names(cd)!="rowname"]
facts <- grep(names(h),pattern="nmf",value=T)
h <- merge.data.table(h,cd,by.x="rn",by.y="rowname")
```

run lmer models one variable at a time, accounting for nested structure as we do for NM-gene associations (within sample within donor).

oddly, even though this whole setup was fine for NM associations, it's causing problems here (warnings about negative eigenvalues). stackexchange suggests changing the optimizer; nelder-mead is one that doesn't require anything further and does not result in warnings.
```{r}
setDTthreads(1,restore_after_fork = FALSE) # prevent resource overcommitment

assocs <- lapply(mdvars,FUN=function(metavar){
    subres <- mclapply(facts,mc.cores=8,FUN=function(fact){
        setDTthreads(1,restore_after_fork=FALSE) # prevent resource overcommitment
        if(is.character(h[[metavar]])){
            set(h,j = metavar,value = as.factor(h[[metavar]]))
        }
        form <- as.formula(paste0(fact," ~ ",metavar," + (1|sample_id) + (1|brnum:sample_id)"))
        m <- lmer(form,data=h,control=lmerControl(optimizer="Nelder_Mead"),REML = T)
        res <- as.data.table(car::Anova(m))
        setnames(res,3,"p")
        res[,variable:=metavar]
        res[,weights:=fact]
        res[,warns:=paste0("'",summary(m)$optinfo$conv$lme4$messages,"'",collapse=" ; ")]
        return(res)
    })
    res <- rbindlist(subres)
    return(res)
})
assocs2 <- rbindlist(assocs)
assocs2[warns=="''",warns:=""]

## calculate bonferroni corrected vals for non-warned tests
assocs2[warns=="",bonf:=p*(nrow(assocs2[warns==""]))]
unique(assocs2[bonf<0.05])
```

## save
```{r}
fwrite(assocs2,"processed-data/10_subclustering/08-lcnmf_spotweights_metadata_assocs_singleVar_lmer_tests.txt",sep="\t",quote=F,row.names=F)
```

repinf
```{r}
sessionInfo()
sessioninfo::session_info()
```
R version 4.4.3 (2025-02-28)
Platform: aarch64-apple-darwin20
Running under: macOS Sequoia 15.3.2

Matrix products: default
BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] parallel  stats     graphics  grDevices utils     methods   base     

other attached packages:
[1] optimx_2024-12.2  car_3.1-3         carData_3.0-5     colorout_1.3-0.2 
[5] lme4_1.1-36       Matrix_1.7-3      data.table_1.17.0 rlang_1.1.5      

loaded via a namespace (and not attached):
 [1] nlme_3.1-167        cli_3.6.4           knitr_1.50          xfun_0.52          
 [5] Formula_1.2-5       reformulas_0.4.0    minqa_1.2.8         rprojroot_2.0.4    
 [9] htmltools_0.5.8.1   pracma_2.4.4        rmarkdown_2.29      grid_4.4.3         
[13] abind_1.4-8         evaluate_1.0.3      MASS_7.3-65         fastmap_1.2.0      
[17] numDeriv_2016.8-1.1 yaml_2.3.10         compiler_4.4.3      sessioninfo_1.2.3  
[21] Rcpp_1.0.14         here_1.0.1          rstudioapi_0.17.1   lattice_0.22-6     
[25] digest_0.6.37       nloptr_2.2.1        Rdpack_2.6.3        splines_4.4.3      
[29] rbibutils_2.3       tools_4.4.3         boot_1.3-31        
> sessioninfo::session_info()
─ Session info ────────────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.4.3 (2025-02-28)
 os       macOS Sequoia 15.3.2
 system   aarch64, darwin20
 ui       RStudio
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       America/Chicago
 date     2025-05-17
 rstudio  2024.07.0-daily+219 Cranberry Hibiscus (desktop)
 pandoc   3.1.11 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools/aarch64/ (via rmarkdown)
 quarto   1.4.555 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/quarto

─ Packages ────────────────────────────────────────────────────────────────────────
 !  package     * version    date (UTC) lib source
    abind         1.4-8      2024-09-12 [1] CRAN (R 4.4.1)
    boot          1.3-31     2024-08-28 [1] CRAN (R 4.4.3)
    car         * 3.1-3      2024-09-27 [1] CRAN (R 4.4.1)
    carData     * 3.0-5      2022-01-06 [1] CRAN (R 4.4.0)
 VP cli           3.6.4      2025-04-23 [2] CRAN (R 4.4.1) (on disk 3.6.5)
    colorout    * 1.3-0.2    2024-05-01 [1] Github (jalvesaq/colorout@c6113a2)
    data.table  * 1.17.0     2025-02-22 [1] CRAN (R 4.4.1)
    digest        0.6.37     2024-08-19 [1] CRAN (R 4.4.1)
    evaluate      1.0.3      2025-01-10 [1] CRAN (R 4.4.1)
    fastmap       1.2.0      2024-05-15 [1] CRAN (R 4.4.0)
    Formula       1.2-5      2023-02-24 [1] CRAN (R 4.4.0)
    here          1.0.1      2020-12-13 [1] CRAN (R 4.4.0)
    htmltools     0.5.8.1    2024-04-04 [1] CRAN (R 4.4.0)
    knitr         1.50       2025-03-16 [1] CRAN (R 4.4.2)
    lattice       0.22-6     2024-03-20 [1] CRAN (R 4.4.3)
    lme4        * 1.1-36     2025-01-11 [1] CRAN (R 4.4.1)
    MASS          7.3-65     2025-02-28 [1] CRAN (R 4.4.1)
    Matrix      * 1.7-3      2025-03-11 [1] CRAN (R 4.4.1)
    minqa         1.2.8      2024-08-17 [1] CRAN (R 4.4.0)
    nlme          3.1-167    2025-01-27 [1] CRAN (R 4.4.3)
    nloptr        2.2.1      2025-03-17 [1] CRAN (R 4.4.1)
    numDeriv      2016.8-1.1 2019-06-06 [1] CRAN (R 4.4.0)
    optimx      * 2024-12.2  2024-12-10 [1] CRAN (R 4.4.1)
    pracma        2.4.4      2023-11-10 [1] CRAN (R 4.4.0)
    rbibutils     2.3        2024-10-04 [1] CRAN (R 4.4.1)
    Rcpp          1.0.14     2025-01-12 [1] CRAN (R 4.4.1)
    Rdpack        2.6.3      2025-03-16 [1] CRAN (R 4.4.2)
    reformulas    0.4.0      2024-11-03 [1] CRAN (R 4.4.1)
 VP rlang       * 1.1.5      2025-04-11 [2] CRAN (R 4.4.1) (on disk 1.1.6)
    rmarkdown     2.29       2024-11-04 [1] CRAN (R 4.4.1)
    rprojroot     2.0.4      2023-11-05 [1] CRAN (R 4.4.0)
    rstudioapi    0.17.1     2024-10-22 [1] CRAN (R 4.4.1)
    sessioninfo   1.2.3      2025-02-05 [1] CRAN (R 4.4.1)
    xfun          0.52       2025-04-02 [1] CRAN (R 4.4.1)
    yaml          2.3.10     2024-07-26 [1] CRAN (R 4.4.0)

 [1] /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library
 [2] /Users/bmulvey/Library/R/arm64/4.4/library

 * ── Packages attached to the search path.
 V ── Loaded and on-disk version mismatch.
 P ── Loaded and on-disk path mismatch.

───────────────────────────────────────────────────────────────────────────────────
