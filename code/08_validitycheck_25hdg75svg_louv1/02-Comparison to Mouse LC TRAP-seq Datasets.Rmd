---
title: "02-Comparison to Mouse LC TRAP-seq Datasets"
author: "Bernie Mulvey"
date: "2025-01-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(ggplot2)
library(ggtext)
library(gridExtra)
library(SpatialExperiment)
library(spatialLIBD)
# library(SpatialFeatureExperiment)

## rstudio GUI tweaks
#require(colorout)
# ColorOut()
# options("styler.addins_style_transformer" = "biocthis::bioc_style()")
##

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc. seemed to need this a couple times, but otherwise havent so its here as a preventative measure. part of this is adding the line 
# OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
# to Renviron.site. see e.g. top response on https://stackoverflow.com/questions/73638290/python-on-mac-is-it-safe-to-set-objc-disable-initialize-fork-safety-yes-globall 
library(parallelly)
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost="localhost")
library(parallel)

## ggplot defaults
theme_set(theme_bw()+theme(axis.text.x = element_text(size = 9), axis.title.x = element_text(size = 8), axis.text.y = element_text(size = 8), axis.title.y = element_text(size =9), plot.title = element_markdown(size = 11,hjust=0.5), strip.text = element_text(size=11), legend.text = element_text(size=8), legend.title = element_text(size=9,hjust=0.5)))

## last of all, unload the base package datasets, whose data keep getting in the way of autocompletions (e.g., Theoph is priortized over TRUE)
unloadNamespace("datasets")
```

### TRAP datasets:
Mulvey et al '18
Iannitelli '23 eneuro: veh treated
" " ": DSP4 treated
Iannitelli '25 preprint: human tyrosinase expression
Iannitelli '25 preprint: useless transgene expression
```{r}
ianmul.veh <- fread("local_ref/DSP4_LCtrap2023_IPpre_sigs_by_tx/sal_IPvPRE.txt")
ianmul.dsp <- fread("local_ref/DSP4_LCtrap2023_IPpre_sigs_by_tx/dsp4_IPvPRE.txt")

htyrs <- readRDS("local_ref/hTyrLCtrap_DE_analyses_Aug2024_VoomLmFit_rep-as-dupcor-variable.rds")
htyr.tyr <- htyrs$IPvsPre_hTyr
htyr.yfp <- htyrs$IPvsPre_EYFP
rm(htyrs)

traps <- list(ianmul.dsp,htyr.tyr,ianmul.veh,htyr.yfp)
names(traps) <- c("DSP4","hTyr","Sal","YFP")

# make gene column name uniform for these and convert to all caps for quiick dirty matching to human genes
traps <- lapply(traps,function(x){setnames(x,1,"gene_name")
    z <- x[,gene_name:=toupper(gene_name)]
    return(z)
})

# collate these into one table of a gene per IP-pre signature
i<-1
for (i in c(1:length(traps))){
    newdat <- traps[[i]][,.(gene_name,t)]
    setnames(newdat,"t",names(traps)[i])
    if(i==1){trapsigs <- copy(newdat)} else{
        trapsigs <- merge.data.table(trapsigs,newdat,by="gene_name",all=T)
    }
    rm(newdat)
}

rm(i,traps,ianmul.dsp,ianmul.veh,htyr.tyr,htyr.yfp)
gc()
```

## load SPE and assign hdg_svg_2575_louv_res1 clusterings as autoannotated (to start with),  divy up into over/under 55yo x E4+- and get LC vs everything else registration stats for each subgroup. don't include sex since we don't know exactly how balanced the male/female tissue proportions were for the TRAP samples. (neither an animal basis nor a mass of tissue basis).
```{r}
lc3 <- readRDS("processed-data/06-countsOnly_noImgData_QCed_SPE_split_to_tissSections.RDS")

louvs <- readRDS("processed-data/07_featureSelection_dimred_harmony_clustering/04-Initial_louvLeid_res0.5-1-2_clusterings.RDS")
louvs <- louvs[["HARMONYlmbna_HDG_SVG_2575"]][,.(rn,snnHARMONYlmbna_HDG_SVG_2575_louv_res1)]
setnames(louvs,2,"clusid")

autoan <- readRDS("processed-data/07_featureSelection_dimred_harmony_clustering/05b-init_clusterings_autoannoLCrapheAndGABAergic.RDS")
autoan <- autoan[["snnHARMONYlmbna_HDG_SVG_2575_louv_res1"]]

louvs <- merge.data.table(louvs,autoan,by="clusid")
louvs[autoanno!="LC.1",autoanno:="Other"]
louvs[autoanno=="LC.1",autoanno:="LC"]
louvs <- DataFrame(louvs,row.names=louvs$rn)[colnames(lc3),]

colLabels(lc3) <- louvs$autoanno

rm(louvs,autoan)

### groupings
lc3$e4pos <- ifelse(lc3$APOE %in% c("E4/ E4","E3/ E4"),yes="E4pos",no="E4neg")
```

registration wrapper by risk group
```{r}
lc3subreg <- lapply(unique(lc3$e4pos),function(rg){
    tmpspe <- lc3[,lc3$e4pos==rg]
    tmprap <- registration_wrapper(tmpspe,var_registration = "label",var_sample_id = "sample_id",gene_name = "gene_name",gene_ensembl = "gene_id",covars=c("Age","Sex"))
    tmprap.dt <- as.data.table(tmprap$enrichment)[,.(gene,t_stat_LC,t_stat_Other)]
    return(tmprap.dt)
})
names(lc3subreg) <- unique(lc3$e4pos)
```

### registration per risk group to each trap signature
```{r}
spatregs <- mclapply(lc3subreg,mc.cores=6,FUN=function(l){
    curdat <- l[,.(gene,t_stat_LC)]
    spatregs.int <- lapply(names(trapsigs)[2:ncol(trapsigs)],FUN = function(s){
        # iterator for top number of genes to use for correlation
        getname <- c("gene_name",s)
        curtrap <- trapsigs[,..getname]
        curtrap <- curtrap[!is.na(get(s))]
        j<-c(seq(10,50,10),seq(75,250,25),seq(300,1000,100))
        i<-1
        cormat <- as.data.frame(matrix(nrow=length(j+1),ncol=1))
        for (i in c(1:(length(j)+1))){
            if(i<length(j)){
                cortab<-merge.data.table(curdat,curtrap,by.x="gene",by.y="gene_name")
                ngene <- j[i]
            }
            else{
                # no value for top_n --> all genes used
                cortab<-merge.data.table(curdat,curtrap,by.x="gene",by.y="gene_name")
                ngene <- nrow(cortab)
            }
            
            setorderv(cortab,s,-1)
                    
            cormat[i,1] <- cor(cortab[c(1:ngene),t_stat_LC],cortab[c(1:ngene),..s],use="pairwise.complete.obs",method = "spearman")
        }
        cormat <- as.data.table(cbind(c(j,nrow(cortab)),cormat))
        setnames(cormat,2,s)
    })
    return(spatregs.int)
})

### merge together within risk group

spatregs2 <- lapply(spatregs,function(s){
    i<-1
    for (i in c(1:length(s))){
        setnames(s[[i]],1,"topNtrapgene")
        if(i==1){rettab <- copy(s[[i]])} else{
            rettab <- merge.data.table(rettab,s[[i]],by="topNtrapgene")
        }
    }
    return(rettab)
})

# concat
spatregs3 <- rbindlist(spatregs2,idcol="LFF_subgroup")

## save
fwrite(spatregs3,"processed-data/08_validitycheck_25hdg75svg_louv1/02-LouvLC_within_epidemRiskGrps_reg_to_msLCtrap.txt",sep='\t',quote=F,row.names=F)
```
