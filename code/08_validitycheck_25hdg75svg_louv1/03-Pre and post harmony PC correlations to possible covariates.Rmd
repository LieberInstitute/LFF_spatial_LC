---
title: "03-Pre and post harmony PC correlations to possible covariates"
author: "Bernie Mulvey"
date: "2025-01-28"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)

## rstudio GUI tweaks
require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")
##

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc. seemed to need this a couple times, but otherwise havent so its here as a preventative measure. part of this is adding the line 
# OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
# to Renviron.site. see e.g. top response on https://stackoverflow.com/questions/73638290/python-on-mac-is-it-safe-to-set-objc-disable-initialize-fork-safety-yes-globall 
library(parallelly)
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost="localhost")

## last of all, unload the base package datasets, whose data keep getting in the way of autocompletions (e.g., Theoph is priortized over TRUE)
unloadNamespace("datasets")
```

load the dimensionality reduction matrices and colData
```{r}
lc3cd <- fread("processed-data/06-QCed_SPE_splitToTissSect_colData.txt")
# fix this stupid brain number thing that I swear I wiped out of the spe before
lc3cd[brnum=="Br6119(re-dis)",brnum:="Br6119"]
## subset to potential covariates: capture_id, APOE, Ancestry, Sex, Age, Rin, Visium_slide, brnum

lc3cd <- lc3cd[,.(rowname, capture_id, APOE, Ancestry, Sex, Age, Rin, Visium_slide,brnum)]

## vector of continuous and categorical covars
catvars <- c("capture_id","APOE","Ancestry","Sex","Visium_slide","brnum")
contvars <- c("Age","Rin")
```

## get uncorrected standard PCA (not glmpca) and post harmony matrix thereof for 25HDG, 75SVG feature set
```{r}
dimrs <- readRDS("processed-data/07_featureSelection_dimred_harmony_clustering/02-PCA_harmo_UMAP_matrices_HiDevG_HVG_SVG_andmixed_featsets.RDS")

# get the 25HDG-75SVG uncorrected standard PCA and harmony
dimrs <- dimrs[c("PCA_HDG_SVG_2575","HARMONYlmbna_HDG_SVG_2575")]
dimrs <- lapply(dimrs,function(d){
    z <- as.data.table(d,keep.rownames=T)
    z <- merge.data.table(z,lc3cd,by.x="rn",by.y="rowname")
    return(z)
})

names(dimrs) <- c("uncorrected_PCA","harmony")
```

#### run correlation tests
```{r}
library(parallel)

setDTthreads(2,restore_after_fork = T) # 6 categorical vars x 2 threads = 12 cores = number of cores on machine

covartests <- mapply(d=dimrs,n=names(dimrs),SIMPLIFY=FALSE,FUN=function(d,n){
    ## get the PC column names
    compcols <- names(d)[!(names(d) %in% c("rn",catvars,contvars))]
    
    # run the continuous covariate tests
    retlist <- mclapply(contvars,mc.cores=length(contvars),FUN=function(co){
        ans <- d[,lapply(.SD,function(pc){
            cor.test(pc,get(co))$estimate
        }),.SDcols=compcols]
        ans[,var:=paste0(co,"_",n)]
        return(ans)
    })
    names(retlist) <- contvars
    
    # run non-normal-assuming tests for categorical covariates
    retlist2 <- mclapply(catvars,mc.cores=length(catvars),FUN=function(ca){
        ans <- d[,lapply(.SD,function(pc){
            kruskal.test(pc,get(ca))$statistic
        }),.SDcols=compcols]
        ans[,var:=paste0(ca,"_",n)]
        return(ans)
    })
    names(retlist2) <- catvars
    
    retlist3 <- c(retlist,retlist2)
    return(retlist3)
})

## concatenate within reduction
covartests <- lapply(covartests,function(l){
    rbindlist(l)
})

## concatenate across reductions
covartests2 <- rbindlist(covartests,fill=T)

# save
fwrite(covartests2,"processed-data/08_validitycheck_25hdg75svg_louv1/03-PotentialCovar_assocs_to_uncorrectedPCs-and-HarmonyPCs.txt",sep='\t',quote=F,row.names=F)
```

### get the max |test stat| for association among uncorrrected and harmony PCs for each ccovariate. if the former is substantially smaller, like an order of magnitude or more, than the latter we're definitely ok on that variable.
```{r}
covartests2 <- melt.data.table(covartests2,id.cols="var")

covartests2[variable %in% grep(variable,pattern="HARMONYlmbna",value=T),dimrtype:="harmony"]

covartests2[is.na(dimrtype),dimrtype:="uncorrected"]

# clear out the null rows since we rbinded two different column sets above
covartests2 <- covartests2[!is.na(value)]
ans <- covartests2[,max(abs(value),na.rm=T),by=c("var","dimrtype")]
ans[,var:=gsub(var,pattern="^(.*)_.*$",replacement="\\1")]
# repeat to get rid of one additional trailing/specifying after-underscored feature
ans[,var:=gsub(var,pattern="^(.*)_.*$",replacement="\\1")]
## fix a couple exceptions to that
ans[var=="capture",var:="capture_id"]
ans[var=="Visium",var:="Visium_slide"]
stopifnot(length(unique(ans$var))==length(c(catvars,contvars)))

ans2 <- dcast(ans,dimrtype~var,value.var = "V1")
# get pre/post correction difference in max variable-PC test stat for each variable; positive values indicate decreased association after harmony integration.
ans3 <- ans2[dimrtype=="uncorrected",c(2:ncol(ans2)),with=FALSE] -ans2[dimrtype=="harmony",c(2:ncol(ans2)),with=FALSE]
# all positive values so we jammin'

```

So we should be good without including additional covariates in the clustering/marker/etc analyses. Which keeps things nice and clean for downstream DE analyses.

rep info
```{r}
sessionInfo()
sessioninfo::session_info()
```
R version 4.4.1 RC (2024-06-06 r86719)
Platform: aarch64-apple-darwin20
Running under: macOS Sonoma 14.7.1

Matrix products: default
BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] parallel  stats     graphics  grDevices utils     methods   base     

other attached packages:
[1] BiocParallel_1.40.0 parallelly_1.40.1   colorout_1.3-0.2    data.table_1.16.4  
[5] rlang_1.1.4        

loaded via a namespace (and not attached):
 [1] digest_0.6.37     codetools_0.2-20  fastmap_1.2.0     xfun_0.49        
 [5] knitr_1.49        htmltools_0.5.8.1 rmarkdown_2.29    cli_3.6.3        
 [9] sessioninfo_1.2.2 compiler_4.4.1    rprojroot_2.0.4   here_1.0.1       
[13] rstudioapi_0.17.1 tools_4.4.1       evaluate_1.0.1    yaml_2.3.10      
> sessioninfo::session_info()
─ Session info ──────────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.4.1 RC (2024-06-06 r86719)
 os       macOS Sonoma 14.7.1
 system   aarch64, darwin20
 ui       RStudio
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       America/Chicago
 date     2025-01-27
 rstudio  2024.07.0-daily+219 Cranberry Hibiscus (desktop)
 pandoc   3.1.11 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools/aarch64/ (via rmarkdown)

─ Packages ──────────────────────────────────────────────────────────────────────
 ! package      * version date (UTC) lib source
   BiocParallel * 1.40.0  2024-11-23 [1] Bioconductor 3.20 (R 4.4.2)
 P cli            3.6.3   2024-06-21 [2] CRAN (R 4.4.0)
   codetools      0.2-20  2024-03-31 [1] CRAN (R 4.4.1)
   colorout     * 1.3-0.2 2024-05-01 [1] Github (jalvesaq/colorout@c6113a2)
   data.table   * 1.16.4  2024-12-06 [1] CRAN (R 4.4.1)
   digest         0.6.37  2024-08-19 [1] CRAN (R 4.4.1)
   evaluate       1.0.1   2024-10-10 [1] CRAN (R 4.4.1)
   fastmap        1.2.0   2024-05-15 [1] CRAN (R 4.4.0)
   here           1.0.1   2020-12-13 [1] CRAN (R 4.4.0)
   htmltools      0.5.8.1 2024-04-04 [1] CRAN (R 4.4.0)
   knitr          1.49    2024-11-08 [1] CRAN (R 4.4.1)
   parallelly   * 1.40.1  2024-12-04 [1] CRAN (R 4.4.1)
 P rlang        * 1.1.4   2024-06-04 [2] CRAN (R 4.4.1)
   rmarkdown      2.29    2024-11-04 [1] CRAN (R 4.4.1)
   rprojroot      2.0.4   2023-11-05 [1] CRAN (R 4.4.0)
   rstudioapi     0.17.1  2024-10-22 [1] CRAN (R 4.4.1)
   sessioninfo    1.2.2   2021-12-06 [1] CRAN (R 4.4.0)
   xfun           0.49    2024-10-31 [1] CRAN (R 4.4.1)
   yaml           2.3.10  2024-07-26 [1] CRAN (R 4.4.0)

 [1] /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library
 [2] /Users/bmulvey/Library/R/arm64/4.4/library

 P ── Loaded and on-disk path mismatch.

─────────────────────────────────────────────────────────────────────────────────
