---
title: "10-intraGlia_and_intraSERT_marker_comparisons"
format: html
author: "Bernie Mulvey"
date: "2025-04-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(ggplot2)
library(ggtext)
library(gridExtra)
library(SpatialExperiment)
library(spatialLIBD)
# library(SpatialFeatureExperiment)

## rstudio GUI tweaks
require(colorout)
ColorOut()
options('styler.addins_style_transformer' = 'biocthis::bioc_style()')
##

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc. seemed to need this a couple times, but otherwise havent so its here as a preventative measure. part of this is adding the line 
# OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
# to Renviron.site. see e.g. top response on https://stackoverflow.com/questions/73638290/python-on-mac-is-it-safe-to-set-objc-disable-initialize-fork-safety-yes-globall 
library(parallelly)
options(parallelly.supportsMulticore.disableOn='')
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost='localhost')
library(parallel)


## ggplot defaults
theme_set(theme_bw()+theme(axis.text.x = element_text(size = 9), axis.title.x = element_text(size = 8), axis.text.y = element_text(size = 8), axis.title.y = element_text(size =9), plot.title = element_markdown(size = 11,hjust=0.5), strip.text = element_text(size=11), legend.text = element_text(size=8), legend.title = element_text(size=9,hjust=0.5),plot.title.position='plot'))

## last of all, unload the base package datasets, whose data keep getting in the way of autocompletions (e.g., Theoph is priortized over TRUE)
unloadNamespace('datasets')
```

## load SPE and cluster assignments/annots
```{r}
lc3 <- readRDS("processed-data/06-countsOnly_noImgData_QCed_SPE_split_to_tissSections.RDS")

louvs <- readRDS("processed-data/07_featureSelection_dimred_harmony_clustering/04-Initial_louvLeid_res0.5-1-2_clusterings.RDS")
louvs <- louvs[["HARMONYlmbna_HDG_SVG_2575"]][,.(rn,snnHARMONYlmbna_HDG_SVG_2575_louv_res1)]
setnames(louvs,2,"clusid")

anno <- fread("processed-data/08_validitycheck_25hdg75svg_louv1/10-25hdg75svg_louv1_annots.txt")
louvs <- merge.data.table(louvs,anno,by="clusid")

louvs <- DataFrame(louvs,row.names=louvs$rn)[colnames(lc3),]

colLabels(lc3) <- louvs$anno

## make an SPE thats just oligo clusters, another thats just astro, a third thats just the acheserts
oligospe <- lc3[,lc3$label %in% c("Oligo_1","Oligo_2","Oligo_3")]
astrospe <- lc3[,lc3$label %in% c("Astro_1","Astro_2_APOE")]
achespe <- lc3[,lc3$label %in% c("ACHE_SERT_SLC17A6_ADCYAP1","ACHE_SERT_SLC17A6_Npeps")]

## make list to parallelize

spel <- list(oligospe,astrospe,achespe)
names(spel) <- c("oligos","astros","ache_serts")

rm(lc3,oligospe,astrospe,achespe,louvs,anno)
gc(full=T)
```

run registration wrapper to get markers per cluster grouping
```{r}
### parallelization fails without useful error messages so just iterate
mkres <- lapply(spel,FUN=function(X){
    # slap a leading "X" on the cluster labels so we can separate them from their output stats 
    X$label <- paste0("X",X$label)

    res <- registration_wrapper(X,var_registration = "label",var_sample_id = "sample_id",gene_name = "gene_name",gene_ensembl = "gene_id",min_ncells = 10)
    res2 <- as.data.table(res$enrichment)

    res2 <- melt.data.table(res2,id.vars=c("ensembl","gene"))
    res2[,stat:=gsub(variable,pattern="^(.*)_X.*$",replacement="\\1")]
    res2[,clus:=gsub(variable,pattern="^.*_X(.*)$",replacement="\\1")]
    res2[,variable:=NULL]

    res2 <- dcast(res2,ensembl+gene+clus~stat,value.var="value")
    return(res2)
})

saveRDS(mkres,"processed-data/08_validitycheck_25hdg75svg_louv1/10-1vsOthers_markers_Oligos_Astros_ACHESERTS.RDS")
```

also, the xenium prioritization seemed to indicate that one of the ACHE_SERT clusters contained some LC, since many genes showed similar (but weaker) patterns to those in the LC cluster in terms of e.g. proportion of spots per cluster expressing a gene, etc. that same cluster has a fair amount of NM. dont recall which it was off the top of my head but the nm metadata should reveal.

## NEED FINAL NM SEGS TO CONTINUE
```{r}
achesertcd <- as.data.table(colData(spel$ache_serts))




```
