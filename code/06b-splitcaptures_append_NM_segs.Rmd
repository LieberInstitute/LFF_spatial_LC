---
title: "06b-splitcaptures_append_NM_segs"
author: "Bernie Mulvey"
date: "2025-02-15"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(ggplot2)
library(gridExtra)
library(SpatialExperiment)
# library(SpatialFeatureExperiment)

## rstudio GUI tweaks
require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")
##

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc. seemed to need this a couple times, but otherwise havent so its here as a preventative measure. part of this is adding the line 
# OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
# to Renviron.site. see e.g. top response on https://stackoverflow.com/questions/73638290/python-on-mac-is-it-safe-to-set-objc-disable-initialize-fork-safety-yes-globall 
library(parallelly)
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost="localhost")


## ggplot defaults
theme_set(theme_bw()+theme(axis.text.x = element_text(size = 9), axis.title.x = element_text(size = 8), axis.text.y = element_text(size = 8), axis.title.y = element_text(size = 9), plot.title = element_text(size = 11,hjust=0.5), strip.text = element_text(size=11), legend.text = element_text(size=8), legend.title = element_text(size=9,hjust=0.5)))

## last of all, unload the base package datasets, whose data keep getting in the way of autocompletions (e.g., Theoph is priortized over TRUE)
unloadNamespace("datasets")
```

get NM segmentations systematically. note that these are capture-area level spot identifiers, not section identifiers. the former are in colData(spe)
```{r}
nmsegs <- list.files("processed-data/01_spaceranger",pattern = "tissue_spot_counts.csv",full.names = TRUE,recursive = TRUE)

nmseglist <- lapply(nmsegs,FUN=function(f){
    tab <- fread(f)
    samp <- gsub(f,pattern="^processed-data/01_spaceranger/(V.*)/outs.*$",replacement="\\1")
    ## append the slide info to the barcodes to match them with the SPE data
    ## this will produce barcode_captureID -- which is unique to one spot in an entire capture area -- and a format we retained in the SPE's colData for this exact sort of purpose
    tab[,barcode:=paste0(barcode,"_",samp)]
    tab <- tab[,.(barcode,NNM,PNM,INM,CNNM)]
    return(tab)
})

nmseglist <- rbindlist(nmseglist)
setnames(nmseglist,c(2:5),c("N_NMbodies","Prop_NM","Intensity_NM","CentroidSignalCount_NM"))

## one sample was tested with read trimming and without after being sent out for sequencing at a different facility than normal, and has untrimmed appended to the filename and thus the re-generated spot id here. remove it
nmseglist[barcode %in% grep(barcode,pattern="_untrimmed",value=T),barcode:=gsub(barcode,pattern="_untrimmed",replacement="")]
```

get both versions of the SPE (w/ and wo image data) to merge this into. also get the existing colData table which is separately saved for purposes where the SPE itself is not needed for loading (e.g., pre-pseudobulked data)
```{r}
lcfull <- readRDS("processed-data/06-QCed_SPE_split_to_tissSections.RDS")
lclite <- readRDS("processed-data/06-countsOnly_noImgData_QCed_SPE_split_to_tissSections.RDS")

cdtxt <- fread("processed-data/06-QCed_SPE_splitToTissSect_colData.txt")

## make sure spot barcodes are identical in all three objects
stopifnot(all(colnames(lcfull)==colnames(lclite))|
          all(colnames(lcfull)==cdtxt$rn)|
          all(colnames(lclite)==cdtxt$rn))

## subset the nm segmentations to retained spots
nmseglist <- nmseglist[barcode %in% lcfull$original_spot_id]
stopifnot(nrow(nmseglist)==ncol(lcfull))

## merge to standalone coldata
colordout <- c(names(cdtxt),names(nmseglist)[2:5])
cdtxt <- merge.data.table(cdtxt,nmseglist,by.x="original_spot_id",by.y="barcode")
cdtxt <- cdtxt[,..colordout]

## incorporate into coldata of lcfull, lclite
nmseglist <- DataFrame(nmseglist,row.names=nmseglist$barcode)[lcfull$original_spot_id,]
nmseglist$barcode <- NULL
colData(lcfull) <- cbind(colData(lcfull),nmseglist)
colData(lclite) <- cbind(colData(lclite),nmseglist)
```

## append tissue section level composite intra-LC NM intensity scores
```{r}
tisscore <- fread("processed-data/Images/NMvsBGNMvsRGBBGNM/NMvsBGNM1.csv")
tisscore <- tisscore[,.(fname,NM1_lc,NM2_lc)]
## reformat to match section levels (s1=NM1, s2=NM2)
tisscore <- melt.data.table(tisscore,id.vars="fname")
tisscore[variable=="NM1_lc",fname:=paste0(fname,"s1")]
tisscore[variable=="NM2_lc",fname:=paste0(fname,"s2")]
tisscore <- tisscore[,.(fname,value)]
setnames(tisscore,"value","tissueNMscore")
### append to coldatas

cdtxt <- merge.data.table(cdtxt,tisscore,by.x="sample_id",by.y="fname")

tmpcd <- as.data.table(colData(lcfull),keep.rownames=T)
tmpcd <- merge.data.table(tmpcd,tisscore,by.x="sample_id",by.y="fname")
tmpcd <- DataFrame(tmpcd,row.names=tmpcd$rn)[colnames(lcfull),]
tmpcd$rn <- NULL
colData(lcfull) <- tmpcd
stopifnot(all(colnames(lcfull)==colnames(lclite)))
colData(lclite) <- tmpcd
```

save the objects
```{r}
fwrite(cdtxt,"processed-data/06-QCed_SPE_splitToTissSect_colData.txt",sep='\t',quote=F,row.names=F,col.names=T)

##
saveRDS(lclite,"processed-data/06-countsOnly_noImgData_QCed_SPE_split_to_tissSections.RDS")

##
saveRDS(lcfull,"processed-data/06-QCed_SPE_split_to_tissSections.RDS")
```

repp inf
```{r}
sessionInfo()
sessioninfo::session_info()
```
R version 4.4.3 (2025-02-28)
Platform: aarch64-apple-darwin20
Running under: macOS Sequoia 15.3.2

Matrix products: default
BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats4    stats     graphics  grDevices utils     methods   base     

other attached packages:
 [1] BiocParallel_1.40.0         parallelly_1.43.0          
 [3] colorout_1.3-0.2            SpatialExperiment_1.16.0   
 [5] SingleCellExperiment_1.28.1 SummarizedExperiment_1.36.0
 [7] Biobase_2.66.0              GenomicRanges_1.58.0       
 [9] GenomeInfoDb_1.42.3         IRanges_2.40.1             
[11] S4Vectors_0.44.0            BiocGenerics_0.52.0        
[13] MatrixGenerics_1.18.1       matrixStats_1.5.0          
[15] gridExtra_2.3               ggplot2_3.5.2              
[17] data.table_1.17.0           rlang_1.1.5                

loaded via a namespace (and not attached):
 [1] generics_0.1.3          SparseArray_1.6.2       lattice_0.22-6         
 [4] digest_0.6.37           magrittr_2.0.3          evaluate_1.0.3         
 [7] grid_4.4.3              RColorBrewer_1.1-3      fastmap_1.2.0          
[10] rprojroot_2.0.4         jsonlite_2.0.0          Matrix_1.7-3           
[13] httr_1.4.7              UCSC.utils_1.2.0        scales_1.4.0           
[16] codetools_0.2-20        abind_1.4-8             cli_3.6.4              
[19] crayon_1.5.3            XVector_0.46.0          DelayedArray_0.32.0    
[22] withr_3.0.2             yaml_2.3.10             S4Arrays_1.6.0         
[25] parallel_4.4.3          tools_4.4.3             dplyr_1.1.4            
[28] GenomeInfoDbData_1.2.13 here_1.0.1              vctrs_0.6.5            
[31] R6_2.6.1                magick_2.8.6            lifecycle_1.0.4        
[34] zlibbioc_1.52.0         pkgconfig_2.0.3         pillar_1.10.2          
[37] gtable_0.3.6            Rcpp_1.0.14             glue_1.8.0             
[40] xfun_0.52               tibble_3.2.1            tidyselect_1.2.1       
[43] rstudioapi_0.17.1       knitr_1.50              dichromat_2.0-0.1      
[46] rjson_0.2.23            farver_2.1.2            htmltools_0.5.8.1      
[49] rmarkdown_2.29          compiler_4.4.3         
> sessioninfo::session_info()
─ Session info ─────────────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.4.3 (2025-02-28)
 os       macOS Sequoia 15.3.2
 system   aarch64, darwin20
 ui       RStudio
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       America/Chicago
 date     2025-05-12
 rstudio  2024.07.0-daily+219 Cranberry Hibiscus (desktop)
 pandoc   3.1.11 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools/aarch64/ (via rmarkdown)
 quarto   1.4.555 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/quarto

─ Packages ─────────────────────────────────────────────────────────────────────────
 !  package              * version date (UTC) lib source
    abind                  1.4-8   2024-09-12 [1] CRAN (R 4.4.1)
    Biobase              * 2.66.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    BiocGenerics         * 0.52.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    BiocParallel         * 1.40.0  2024-11-23 [1] Bioconductor 3.20 (R 4.4.2)
 VP cli                    3.6.4   2025-04-23 [2] CRAN (R 4.4.1) (on disk 3.6.5)
    codetools              0.2-20  2024-03-31 [1] CRAN (R 4.4.3)
    colorout             * 1.3-0.2 2024-05-01 [1] Github (jalvesaq/colorout@c6113a2)
    crayon                 1.5.3   2024-06-20 [1] CRAN (R 4.4.0)
    data.table           * 1.17.0  2025-02-22 [1] CRAN (R 4.4.1)
    DelayedArray           0.32.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    dichromat              2.0-0.1 2022-05-02 [1] CRAN (R 4.4.0)
    digest                 0.6.37  2024-08-19 [1] CRAN (R 4.4.1)
    dplyr                  1.1.4   2023-11-17 [1] CRAN (R 4.4.0)
    evaluate               1.0.3   2025-01-10 [1] CRAN (R 4.4.1)
    farver                 2.1.2   2024-05-13 [1] CRAN (R 4.4.0)
    fastmap                1.2.0   2024-05-15 [1] CRAN (R 4.4.0)
    generics               0.1.3   2022-07-05 [1] CRAN (R 4.4.0)
    GenomeInfoDb         * 1.42.3  2025-01-27 [1] Bioconductor 3.20 (R 4.4.2)
    GenomeInfoDbData       1.2.13  2024-12-12 [1] Bioconductor
    GenomicRanges        * 1.58.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    ggplot2              * 3.5.2   2025-04-09 [1] CRAN (R 4.4.1)
    glue                   1.8.0   2024-09-30 [1] CRAN (R 4.4.1)
    gridExtra            * 2.3     2017-09-09 [1] CRAN (R 4.4.0)
    gtable                 0.3.6   2024-10-25 [1] CRAN (R 4.4.1)
    here                   1.0.1   2020-12-13 [1] CRAN (R 4.4.0)
    htmltools              0.5.8.1 2024-04-04 [1] CRAN (R 4.4.0)
    httr                   1.4.7   2023-08-15 [1] CRAN (R 4.4.0)
    IRanges              * 2.40.1  2024-12-05 [1] Bioconductor 3.20 (R 4.4.2)
    jsonlite               2.0.0   2025-03-27 [1] CRAN (R 4.4.1)
    knitr                  1.50    2025-03-16 [1] CRAN (R 4.4.2)
    lattice                0.22-6  2024-03-20 [1] CRAN (R 4.4.3)
    lifecycle              1.0.4   2023-11-07 [1] CRAN (R 4.4.0)
    magick                 2.8.6   2025-03-23 [1] CRAN (R 4.4.1)
    magrittr               2.0.3   2022-03-30 [1] CRAN (R 4.4.0)
    Matrix                 1.7-3   2025-03-11 [1] CRAN (R 4.4.1)
    MatrixGenerics       * 1.18.1  2025-01-09 [1] Bioconductor 3.20 (R 4.4.2)
    matrixStats          * 1.5.0   2025-01-07 [1] CRAN (R 4.4.1)
    parallelly           * 1.43.0  2025-03-24 [1] CRAN (R 4.4.1)
    pillar                 1.10.2  2025-04-05 [1] CRAN (R 4.4.1)
    pkgconfig              2.0.3   2019-09-22 [1] CRAN (R 4.4.0)
    R6                     2.6.1   2025-02-15 [1] CRAN (R 4.4.1)
    RColorBrewer           1.1-3   2022-04-03 [1] CRAN (R 4.4.0)
    Rcpp                   1.0.14  2025-01-12 [1] CRAN (R 4.4.1)
    rjson                  0.2.23  2024-09-16 [1] CRAN (R 4.4.1)
 VP rlang                * 1.1.5   2025-04-11 [2] CRAN (R 4.4.1) (on disk 1.1.6)
    rmarkdown              2.29    2024-11-04 [1] CRAN (R 4.4.1)
    rprojroot              2.0.4   2023-11-05 [1] CRAN (R 4.4.0)
    rstudioapi             0.17.1  2024-10-22 [1] CRAN (R 4.4.1)
    S4Arrays               1.6.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    S4Vectors            * 0.44.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    scales                 1.4.0   2025-04-24 [1] CRAN (R 4.4.1)
    sessioninfo            1.2.3   2025-02-05 [1] CRAN (R 4.4.1)
    SingleCellExperiment * 1.28.1  2024-11-23 [1] Bioconductor 3.20 (R 4.4.2)
    SparseArray            1.6.2   2025-02-20 [1] Bioconductor 3.20 (R 4.4.2)
    SpatialExperiment    * 1.16.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    SummarizedExperiment * 1.36.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    tibble                 3.2.1   2023-03-20 [1] CRAN (R 4.4.0)
    tidyselect             1.2.1   2024-03-11 [1] CRAN (R 4.4.0)
    UCSC.utils             1.2.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    vctrs                  0.6.5   2023-12-01 [1] CRAN (R 4.4.0)
    withr                  3.0.2   2024-10-28 [1] CRAN (R 4.4.1)
    xfun                   0.52    2025-04-02 [1] CRAN (R 4.4.1)
    XVector                0.46.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    yaml                   2.3.10  2024-07-26 [1] CRAN (R 4.4.0)
    zlibbioc               1.52.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)

 [1] /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library
 [2] /Users/bmulvey/Library/R/arm64/4.4/library

 * ── Packages attached to the search path.
 V ── Loaded and on-disk version mismatch.
 P ── Loaded and on-disk path mismatch.

────────────────────────────────────────────────────────────────────────────────────
