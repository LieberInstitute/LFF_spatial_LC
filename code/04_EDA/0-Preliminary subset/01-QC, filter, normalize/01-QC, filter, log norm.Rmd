---
title: "01-QC, filter, log norm"
author: "Bernard Mulvey"
date: "2024-05-12       "
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
knitr::opts_chunk$set(fig.width=7,fig.height=10)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(Biostrings)
library(ggplot2)
library(gridExtra)
library(SpatialExperiment)
library(spatialLIBD)
require(colorout)
library(scran)
source("~/.R/calc_tau_for_cellOrTissueSpecificity_metric.R")
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")

## change write.table to output a TSV without quotes or rownames by default
library(default)
default(write.table) <- list(row.names=F,col.names=T,sep='\t',quote=F)

theme_set(theme_bw()+theme(axis.text.x = element_text(size = 14), axis.title.x = element_text(size = 16), axis.text.y = element_text(size = 14), axis.title.y = element_text(size =16), plot.title = element_text(size = 20,hjust=0.5), strip.text = element_text(size=18), legend.text = element_text(size=10), legend.title = element_text(size=11,hjust=0.5)))
```


### from the initial sample set (Oct 2023), the following samples had few or no TH+ or DBH+ spots, so we'll remove them for now:
exclude: br5854, br5712, br1691, br2305, br5276,br1039,br5517
```{r}
lc <- readRDS("processed-data/02_build_spe/spe_raw_uniquecolnames.RDS")
colnames(lc) <- lc$key
lc$sample_id <- gsub(lc$sample_id,pattern="^(.*-.*)-(.*)$",replacement=paste0("\\1","_","\\2"))

### add brnums and filter
demos <- fread("raw-data/demos.txt")
demos <- demos[,.(slide,array,Donors)]
demos[,samp:=paste0(slide,"_",array)]
setnames(demos,3,"brnum")
demos <- demos[samp %in% colData(lc)$sample_id]
tmpcd <- as.data.table(colData(lc),keep.rownames=T)
tmpcd2 <- merge.data.table(tmpcd,demos,by.x="sample_id",by.y="samp")

tmpcd2 <- DataFrame(tmpcd2)
rownames(tmpcd2) <- tmpcd2$rn
tmpcd2 <- tmpcd2[colnames(lc),]
colData(lc) <- DataFrame(tmpcd2)
stopifnot(colData(lc)$key==colData(lc)$rn)

lc <- lc[,!(lc$brnum %in% c("Br5854","Br5712","Br1691","Br2305","Br5276","Br1039","Br5517"))]
stopifnot(colnames(lc)==colnames(lc)$key)

rm(tmpcd,tmpcd2)
```

## oo % mitochondrial already added in! Thanks Ryan!

### Ch9: QC / filtering
1. Is the tissue oriented correctly? -- REVISIT (not all anatomy/ish/slide images cross-mapped yet) (and it's impossible to tell just plotting spots since these are almost all perfect squares)
```{r}

# get rid of non-tissue spots
lc2 <- lc[,colData(lc)$in_tissue]
sum(colData(lc2)$in_tissue != 1, na.rm = T)
rm(lc)
gc(full=T)
# qed
```

plot some qc stats
### mitochondrial read %age
```{r}
hist(colData(lc2)$expr_chrM_ratio)
# long tail here, we won't filter on this at all
```

### UMIs per spot
### standard threshold is 600 UMIs
```{r}
ggplot(as.data.frame(colData(lc2)), aes(x = log(sum_umi))) +
    geom_histogram(binwidth = 0.3)+
  geom_vline(xintercept = 2.5,col="red") # approx 300
dev.off()

sum(colData(lc2)$sum_umi<300,na.rm=T)
sum(colData(lc2)$sum_umi<200,na.rm=T)

# 300 = drop 15.8k spots of 80some
# 200 = drop 12k of 80some -- we'll be gentle for now @ 200
```

### also look at sum UMIs PER # cells per spot, if available (not available yet)
```{r}
# plotQC(lc2,type = "scatter",metric_x = "cell_count",metric_y ="sum_umi",threshold_y = 600)
# splc@colData$cell_count <- sample(x=c(1:7),size=nrow(splc@colData),replace = T)
# hist(colData(splc)$cell_count,breaks = 20)
```

### genes per spot (sum_gene)
```{r}
ggplot(as.data.table(colData(lc2)),aes(x=sum_gene)) +
    geom_histogram(binwidth = 50)+
    geom_vline(xintercept = 130,col="red")+
    xlim(0,800)
dev.off()


### we'll be gentle again and do 130 for now
### hm..there's this little jump in the ~1k-1.1k genes range. but otherwise ~450 genes looks like it cuts the very tail (and we certainly could have < 600 genes with 600 umis). so let's start with 450 genes minimum detected. again, 070123 spe was already filtered to this threshold.
```

# we would look at # unique genes per spot as a function of cells per spot like this
```{r}
# plotQC(lc2,type = "scatter",metric_x = "cell_count",metric_y ="sum",threshold_y = 600)
dev.off()
# as before, if we wanted to flag spots with more than 10 cells for exclusion (e.g., if that seems to be where the number of genes per spot dives off), then we add a new column to coldata as T/F:
```

### and eventually, let's visually check that spots with higher cell content are not all in one area of their tissue sections (which would indicate something biology-y happening)
```{r}
# plotSpots(lc2,annotate = "cell_count")
# dev.off()
```

### double check UMI and gene count cutoffs against spots for spatial patterns
```{r}
plt <- spatialLIBD::vis_grid_gene(lc2,geneid  = "sum_umi",return_plots = T,spatial = F,point_size = 1,auto_crop = T)
plt <- lapply(plt,FUN=function(x){x+theme(axis.title = element_blank(),axis.text = element_blank(),plot.title = element_text(size = 8),plot.caption = element_text(size=8),legend.text = element_text(size=6),legend.title = element_text(size=9))
    return(x)})

do.call("grid.arrange",c(plt))
dev.off()
rm(plt)
```

### apply mitochondria, UMI, unique gene cutoffs per above (35%, over 600, over 450) (again, 070123 spe was already filtered to these thresholds)
```{r}
ncol(lc2[,colData(lc2)$sum_umi>199&colData(lc2)$sum_gene>129&colData(lc2)$expr_chrM_ratio<1])/ncol(lc2)
lc2 <- lc2[,colData(lc2)$sum_umi>199&colData(lc2)$sum_gene>129&colData(lc2)$expr_chrM_ratio<1]
```

### apply library-size normalized, LOG COUNT normalization AFTER filtering the data.
```{r}
library(scran)
lc2 <- computeLibraryFactors(lc2)
# peek
summary(sizeFactors(lc2))
hist(sizeFactors(lc2),breaks=100)
dev.off()
# append log counts using scater (don't use the SpatialExpt:: function here, that's for RETRIEVING an assay by the name of "logcounts" from spe objs)
lc2 <- scater::logNormCounts(lc2)
### save
saveRDS(lc2,"local_ref/eda_lc_spe_nomitofilt_200umi-130gene_nonLCsampsdropped_051224.RDS")
```
