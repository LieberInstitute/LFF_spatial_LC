---
title: "03-Initial glmPCAs"
author: "Bernie Mulvey"
date: "2024-12-25"
output: html_document
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(SpatialExperiment)
library(scran)
library(scater)
library(scry)
library(glmpca)
library(harmony)
# library(SpatialFeatureExperiment)

## rstudio GUI tweaks
require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")
##

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc. seemed to need this a couple times, but otherwise havent so its here as a preventative measure. part of this is adding the line 
# OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
# to Renviron.site. see e.g. top response on https://stackoverflow.com/questions/73638290/python-on-mac-is-it-safe-to-set-objc-disable-initialize-fork-safety-yes-globall 
library(parallelly)
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost="localhost")

## last of all, unload the base package datasets, whose data keep getting in the way of autocompletions (e.g., Theoph is priortized over TRUE)
unloadNamespace("datasets")
```

### load SPE and feature sets
```{r}
lc3 <- readRDS("processed-data/06-QCed_SPE_split_to_tissSections.RDS")

feats <- readRDS("processed-data/07_featureSelection_dimred_harmony_clustering/01d_HiDevG_HVG_SVG_andmixed_featsets.RDS")
```


to approximate glm-PCA for the feature set, we will first run nullResiduals, and then from the result run PCA using scater as before.

per scry docs, "To avoid memory issues, it is recommended to perform feature selection first and subset the number of features to a smaller size prior to computing the residuals." So we'll step thru it this way.

Scale should be set to TRUE for runPCA, per scry-glmpca approximation guide: https://www.stephaniehicks.com/biocdemo/articles/Demo.html#glm-pca
```{r}
## make a simplified object to save memory (no image data, no logcounts)
smollc <- SingleCellExperiment(colData=colData(lc3),rowData=rowData(lc3),assays=list(counts=counts(lc3)))
rm(lc3)    
gc(full=T)


glmpcas <- list()

i<-1
for (i in c(1:length(feats))){
    
    ## subset to currently selected features
    tmplc <- smollc[feats[[i]],]
    
    ## calculate null residuals
    tmplc <- nullResiduals(tmplc,assay="counts",type="deviance")
    
    set.seed(42)
    tmplc <- scater::runPCA(x=tmplc,subset_row=feats[[i]],exprs_values="binomial_deviance_residuals",ntop=length(feats[[i]]),ncomponents=50,scale=TRUE,BSPARAM=BiocSingular::RandomParam(),name=paste0("glmPCA_",names(feats)[i]))
    
    gc(full=T)

    # standard UMAPs (which require PCA first)
    set.seed(42)
    tmplc <- scater::runUMAP(tmplc,dimred=paste0("glmPCA_",names(feats)[i]),name=paste0("UMAP_",names(feats)[i]))
    
    
    # harmony runs -- we need to temporarily rename the PCA for the feature set to "PCA" for runharmony to accept it
    reducedDimNames(tmplc)[which(reducedDimNames(tmplc)==paste0("glmPCA_",names(feats)[i]))] <- "PCA"
    
    
    # data-based initialization of lambda (development ver of Harmony; requires explicit lambda=NULL)
    set.seed(42)
    tmplc <- RunHarmony(tmplc,lambda=NULL,group.by.vars="sample_id",reduction.save=paste0("HARMONYlmbna_glmPCA_",names(feats)[i]))
    
    # restore the feature-set-specific name for the uncorrected PCA
    reducedDimNames(tmplc)[which(reducedDimNames(tmplc)=="PCA")] <- paste0("glmPCA_",names(feats)[i])
    
    
    # UMAP of data-based initialization of lambda
    set.seed(42)
    tmplc <- scater::runUMAP(tmplc,dimred=paste0("HARMONYlmbna_glmPCA_",names(feats)[i]),name=paste0("HARMONYlmbna_glmPCA_",names(feats)[i],"_UMAP"))
    
    # extract reduced dims for the feature set, make a not-S4 list, store in output list
    retlist <- reducedDims(tmplc)
    retlist <- as.list(retlist)
    glmpcas[[i]] <- retlist
    names(glmpcas)[i] <- names(feats)[i]
    
    # clear space for next run
    rm(retlist,tmplc)
    gc(full=T)
}

## check that we have 4 reduced dim mats in each list (feature set) from each feature set
stopifnot(sum(unlist(lapply(glmpcas,function(x){length(x)==4})))==length(glmpcas))
```

```{r}
glmpcas2 <- list()

i <- 1
for (i in c(1:length(glmpcas))){
    glmpcas2 <- c(glmpcas2,glmpcas[[i]])
}

saveRDS(glmpcas2,"processed-data/07_featureSelection_dimred_harmony_clustering/03-initial_HDG-SVG-HVG_sets_nullResid_to_approxGLMPCA.RDS")
```

reprod inf
```{r}
sessionInfo()
sessioninfo::session_info()
```
R version 4.4.1 RC (2024-06-06 r86719)
Platform: aarch64-apple-darwin20
Running under: macOS Sonoma 14.7.1

Matrix products: default
BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats4    stats     graphics  grDevices utils     methods   base     

other attached packages:
 [1] harmony_1.2.3               Rcpp_1.0.13-1              
 [3] scater_1.34.0               ggplot2_3.5.1              
 [5] scran_1.34.0                scuttle_1.16.0             
 [7] BiocParallel_1.40.0         parallelly_1.40.1          
 [9] colorout_1.3-0.2            HDF5Array_1.34.0           
[11] rhdf5_2.50.0                DelayedArray_0.32.0        
[13] SparseArray_1.6.0           S4Arrays_1.6.0             
[15] abind_1.4-8                 Matrix_1.7-1               
[17] glmpca_0.2.0                scry_1.18.0                
[19] SpatialExperiment_1.16.0    SingleCellExperiment_1.28.1
[21] SummarizedExperiment_1.36.0 Biobase_2.66.0             
[23] GenomicRanges_1.58.0        GenomeInfoDb_1.42.1        
[25] IRanges_2.40.1              S4Vectors_0.44.0           
[27] BiocGenerics_0.52.0         MatrixGenerics_1.18.0      
[29] matrixStats_1.4.1           data.table_1.16.4          
[31] rlang_1.1.4                

loaded via a namespace (and not attached):
 [1] gridExtra_2.3           magrittr_2.0.3          RcppAnnoy_0.0.22       
 [4] compiler_4.4.1          vctrs_0.6.5             pkgconfig_2.0.3        
 [7] crayon_1.5.3            fastmap_1.2.0           magick_2.8.5           
[10] XVector_0.46.0          labeling_0.4.3          utf8_1.2.4             
[13] rmarkdown_2.29          sessioninfo_1.2.2       UCSC.utils_1.2.0       
[16] ggbeeswarm_0.7.2        xfun_0.49               bluster_1.16.0         
[19] zlibbioc_1.52.0         beachmat_2.22.0         jsonlite_1.8.9         
[22] rhdf5filters_1.18.0     Rhdf5lib_1.28.0         irlba_2.3.5.1          
[25] parallel_4.4.1          cluster_2.1.8           R6_2.5.1               
[28] limma_3.62.1            knitr_1.49              igraph_2.1.2           
[31] tidyselect_1.2.1        rstudioapi_0.17.1       yaml_2.3.10            
[34] viridis_0.6.5           codetools_0.2-20        lattice_0.22-6         
[37] tibble_3.2.1            withr_3.0.2             evaluate_1.0.1         
[40] pillar_1.9.0            generics_0.1.3          rprojroot_2.0.4        
[43] munsell_0.5.1           scales_1.3.0            RhpcBLASctl_0.23-42    
[46] glue_1.8.0              metapod_1.14.0          tools_4.4.1            
[49] BiocNeighbors_2.0.1     ScaledMatrix_1.14.0     locfit_1.5-9.10        
[52] cowplot_1.1.3           grid_4.4.1              edgeR_4.4.1            
[55] colorspace_2.1-1        GenomeInfoDbData_1.2.13 beeswarm_0.4.0         
[58] BiocSingular_1.22.0     vipor_0.4.7             cli_3.6.3              
[61] rsvd_1.0.5              fansi_1.0.6             viridisLite_0.4.2      
[64] dplyr_1.1.4             uwot_0.2.2              gtable_0.3.6           
[67] digest_0.6.37           ggrepel_0.9.6           dqrng_0.4.1            
[70] farver_2.1.2            rjson_0.2.23            htmltools_0.5.8.1      
[73] lifecycle_1.0.4         httr_1.4.7              here_1.0.1             
[76] statmod_1.5.0           MASS_7.3-61            
> sessioninfo::session_info()
─ Session info ──────────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.4.1 RC (2024-06-06 r86719)
 os       macOS Sonoma 14.7.1
 system   aarch64, darwin20
 ui       RStudio
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       America/Chicago
 date     2024-12-25
 rstudio  2024.07.0-daily+219 Cranberry Hibiscus (desktop)
 pandoc   3.1.11 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools/aarch64/ (via rmarkdown)

─ Packages ──────────────────────────────────────────────────────────────────────
 ! package              * version  date (UTC) lib source
   abind                * 1.4-8    2024-09-12 [1] CRAN (R 4.4.1)
   beachmat               2.22.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   beeswarm               0.4.0    2021-06-01 [1] CRAN (R 4.4.0)
   Biobase              * 2.66.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   BiocGenerics         * 0.52.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   BiocNeighbors          2.0.1    2024-11-28 [1] Bioconductor 3.20 (R 4.4.2)
   BiocParallel         * 1.40.0   2024-11-23 [1] Bioconductor 3.20 (R 4.4.2)
   BiocSingular           1.22.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   bluster                1.16.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
 P cli                    3.6.3    2024-06-21 [2] CRAN (R 4.4.0)
   cluster                2.1.8    2024-12-11 [1] CRAN (R 4.4.1)
   codetools              0.2-20   2024-03-31 [1] CRAN (R 4.4.1)
   colorout             * 1.3-0.2  2024-05-01 [1] Github (jalvesaq/colorout@c6113a2)
   colorspace             2.1-1    2024-07-26 [1] CRAN (R 4.4.0)
   cowplot                1.1.3    2024-01-22 [1] CRAN (R 4.4.0)
   crayon                 1.5.3    2024-06-20 [1] CRAN (R 4.4.0)
   data.table           * 1.16.4   2024-12-06 [1] CRAN (R 4.4.1)
   DelayedArray         * 0.32.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   digest                 0.6.37   2024-08-19 [1] CRAN (R 4.4.1)
   dplyr                  1.1.4    2023-11-17 [1] CRAN (R 4.4.0)
   dqrng                  0.4.1    2024-05-28 [1] CRAN (R 4.4.0)
   edgeR                  4.4.1    2024-12-02 [1] Bioconductor 3.20 (R 4.4.2)
   evaluate               1.0.1    2024-10-10 [1] CRAN (R 4.4.1)
   fansi                  1.0.6    2023-12-08 [1] CRAN (R 4.4.0)
   farver                 2.1.2    2024-05-13 [1] CRAN (R 4.4.0)
   fastmap                1.2.0    2024-05-15 [1] CRAN (R 4.4.0)
   generics               0.1.3    2022-07-05 [1] CRAN (R 4.4.0)
   GenomeInfoDb         * 1.42.1   2024-11-28 [1] Bioconductor 3.20 (R 4.4.2)
   GenomeInfoDbData       1.2.13   2024-12-12 [1] Bioconductor
   GenomicRanges        * 1.58.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   ggbeeswarm             0.7.2    2023-04-29 [1] CRAN (R 4.4.0)
   ggplot2              * 3.5.1    2024-04-23 [1] CRAN (R 4.4.0)
   ggrepel                0.9.6    2024-09-07 [1] CRAN (R 4.4.1)
   glmpca               * 0.2.0    2020-07-18 [1] CRAN (R 4.4.0)
   glue                   1.8.0    2024-09-30 [1] CRAN (R 4.4.1)
   gridExtra              2.3      2017-09-09 [1] CRAN (R 4.4.0)
   gtable                 0.3.6    2024-10-25 [1] CRAN (R 4.4.1)
   harmony              * 1.2.3    2024-11-27 [1] CRAN (R 4.4.1)
   HDF5Array            * 1.34.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   here                   1.0.1    2020-12-13 [1] CRAN (R 4.4.0)
   htmltools              0.5.8.1  2024-04-04 [1] CRAN (R 4.4.0)
   httr                   1.4.7    2023-08-15 [1] CRAN (R 4.4.0)
   igraph                 2.1.2    2024-12-07 [1] CRAN (R 4.4.1)
   IRanges              * 2.40.1   2024-12-05 [1] Bioconductor 3.20 (R 4.4.2)
   irlba                  2.3.5.1  2022-10-03 [1] CRAN (R 4.4.0)
   jsonlite               1.8.9    2024-09-20 [1] CRAN (R 4.4.1)
   knitr                  1.49     2024-11-08 [1] CRAN (R 4.4.1)
   labeling               0.4.3    2023-08-29 [1] CRAN (R 4.4.0)
   lattice                0.22-6   2024-03-20 [1] CRAN (R 4.4.1)
   lifecycle              1.0.4    2023-11-07 [1] CRAN (R 4.4.0)
   limma                  3.62.1   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   locfit                 1.5-9.10 2024-06-24 [1] CRAN (R 4.4.0)
   magick                 2.8.5    2024-09-20 [1] CRAN (R 4.4.1)
   magrittr               2.0.3    2022-03-30 [1] CRAN (R 4.4.0)
   MASS                   7.3-61   2024-06-13 [1] CRAN (R 4.4.0)
   Matrix               * 1.7-1    2024-10-18 [1] CRAN (R 4.4.1)
   MatrixGenerics       * 1.18.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   matrixStats          * 1.4.1    2024-09-08 [1] CRAN (R 4.4.1)
   metapod                1.14.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   munsell                0.5.1    2024-04-01 [1] CRAN (R 4.4.0)
   parallelly           * 1.40.1   2024-12-04 [1] CRAN (R 4.4.1)
   pillar                 1.9.0    2023-03-22 [1] CRAN (R 4.4.0)
   pkgconfig              2.0.3    2019-09-22 [1] CRAN (R 4.4.0)
   R6                     2.5.1    2021-08-19 [1] CRAN (R 4.4.0)
   Rcpp                 * 1.0.13-1 2024-11-02 [1] CRAN (R 4.4.1)
   RcppAnnoy              0.0.22   2024-01-23 [1] CRAN (R 4.4.0)
   rhdf5                * 2.50.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   rhdf5filters           1.18.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   Rhdf5lib               1.28.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   RhpcBLASctl            0.23-42  2023-02-11 [1] CRAN (R 4.4.0)
   rjson                  0.2.23   2024-09-16 [1] CRAN (R 4.4.1)
 P rlang                * 1.1.4    2024-06-04 [2] CRAN (R 4.4.1)
   rmarkdown              2.29     2024-11-04 [1] CRAN (R 4.4.1)
   rprojroot              2.0.4    2023-11-05 [1] CRAN (R 4.4.0)
   rstudioapi             0.17.1   2024-10-22 [1] CRAN (R 4.4.1)
   rsvd                   1.0.5    2021-04-16 [1] CRAN (R 4.4.0)
   S4Arrays             * 1.6.0    2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   S4Vectors            * 0.44.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   ScaledMatrix           1.14.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   scales                 1.3.0    2023-11-28 [1] CRAN (R 4.4.0)
   scater               * 1.34.0   2024-10-29 [1] Bioconductor 3.20 (R 4.4.1)
   scran                * 1.34.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   scry                 * 1.18.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   scuttle              * 1.16.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   sessioninfo            1.2.2    2021-12-06 [1] CRAN (R 4.4.0)
   SingleCellExperiment * 1.28.1   2024-11-23 [1] Bioconductor 3.20 (R 4.4.2)
   SparseArray          * 1.6.0    2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   SpatialExperiment    * 1.16.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   statmod                1.5.0    2023-01-06 [1] CRAN (R 4.4.0)
   SummarizedExperiment * 1.36.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   tibble                 3.2.1    2023-03-20 [1] CRAN (R 4.4.0)
   tidyselect             1.2.1    2024-03-11 [1] CRAN (R 4.4.0)
   UCSC.utils             1.2.0    2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   utf8                   1.2.4    2023-10-22 [1] CRAN (R 4.4.0)
   uwot                   0.2.2    2024-04-21 [1] CRAN (R 4.4.0)
   vctrs                  0.6.5    2023-12-01 [1] CRAN (R 4.4.0)
   vipor                  0.4.7    2023-12-18 [1] CRAN (R 4.4.0)
   viridis                0.6.5    2024-01-29 [1] CRAN (R 4.4.0)
   viridisLite            0.4.2    2023-05-02 [1] CRAN (R 4.4.0)
   withr                  3.0.2    2024-10-28 [1] CRAN (R 4.4.1)
   xfun                   0.49     2024-10-31 [1] CRAN (R 4.4.1)
   XVector                0.46.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
   yaml                   2.3.10   2024-07-26 [1] CRAN (R 4.4.0)
   zlibbioc               1.52.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)

 [1] /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library
 [2] /Users/bmulvey/Library/R/arm64/4.4/library

 P ── Loaded and on-disk path mismatch.

─────────────────────────────────────────────────────────────────────────────────
