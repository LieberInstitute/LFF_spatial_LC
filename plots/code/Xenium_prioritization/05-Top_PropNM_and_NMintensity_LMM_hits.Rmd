---
title: "05-Top_PropNM_and_NMintensity_LMM_hits"
author: "Bernie Mulvey"
date: "2025-03-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(fig.height = 10,fig.width = 7,include = FALSE)
#### sets tab autocompletion for directories to begin from the directory containing the .Rproj session, instead of the script's directory if different
knitr::opts_knit$set(root.dir = here::here())

library(data.table)
library(ggplot2)
library(ggtext)
library(gridExtra)
library(SpatialExperiment)
# library(SpatialFeatureExperiment)

## rstudio GUI tweaks
require(colorout)
ColorOut()
options("styler.addins_style_transformer" = "biocthis::bioc_style()")
##

## enable forked parallel processing with BiocParallel::multicoreParam, future::, etc. seemed to need this a couple times, but otherwise havent so its here as a preventative measure. part of this is adding the line 
# OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES
# to Renviron.site. see e.g. top response on https://stackoverflow.com/questions/73638290/python-on-mac-is-it-safe-to-set-objc-disable-initialize-fork-safety-yes-globall 
library(parallelly)
options(parallelly.supportsMulticore.disableOn="")
options(parallelly.fork.enable=TRUE)
library(BiocParallel)
options(bphost="localhost")


## ggplot defaults for this script (no strip)
theme_set(theme_bw()+theme(axis.text.x = element_text(size = 9), axis.title.x = element_text(size = 8), axis.text.y = element_text(size = 8), axis.title.y = element_text(size =9), plot.title = element_markdown(size = 11,hjust=0.5), strip.text = element_text(size=8),strip.background = element_blank(),legend.text = element_text(size=8), legend.title = element_text(size=9,hjust=0.5)))

## last of all, unload the base package datasets, whose data keep getting in the way of autocompletions (e.g., Theoph is priortized over TRUE)
unloadNamespace("datasets")
```

## get nm LMM results
```{r}
nms <- readRDS("processed-data/Xenium_prioritization/05-LCNMspots_geneLogcounts_LMMed_by_NMmetric.RDS")

## filter to genes with uncorrected p < 0.05/number of genes modeled
## for both metrics this is a p cutoff of 2.4 * 10^-6
nms <- mapply(d=nms,n=names(nms),SIMPLIFY=FALSE,function(d,n){
    ## get genes for which the NM metric p value met this^ threshold 
    gs <- d[rn==n&p<0.05/(nrow(d)/length(unique(d$rn))),gene_name]
    # subset to those genes
    e <- d[gene_name %in% gs]
    return(e)
})
nms.allcoefs <- rbindlist(nms)
## determine how many of these associations were nominally significant for each fixed covariate in the model (to decide which to code into the plots downstream)
nms.allcoefs[p<0.05,.N,by="rn"]
## 73 Sex, 43 age, 12 e4copies.
## so we'll want to plot some genes by each of these.
## Sex is changed to SexM in the model result tables, so for matching it to the actual covariate by name, replace it with "Sex"
nms.allcoefs[rn=="SexM",rn:="Sex"]

## hyphens in gene symbols got converted to dots somehow, so fix that
nms.allcoefs[,gene_name:=gsub("\\.","-",gene_name)]
## fix the exception which SHOULD have a period: AL627171.2
nms.allcoefs[gene_name=="AL627171-2",gene_name:="AL627171.2"]
```

##  subset only to genes that are nominally enriched in LC (reardless of NM status) from marker testing
```{r}
mks <- fread("processed-data/08_validitycheck_25hdg75svg_louv1/08-25hdg75svg_louv1_markers.txt")
## X6 is LC
lcgene <- mks[clus=="X6"&p_value<0.05&logFC>0,gene]

nms.allcoefs <- nms.allcoefs[gene_name %in% lcgene]

rm(mks,lcgene)
```

read in spe, subset to NM+ cells in LC cluster
```{r}
lc3 <- readRDS("processed-data/06-countsOnly_noImgData_QCed_SPE_split_to_tissSections.RDS")

## calculate log counts
lc3 <- scater::computeLibraryFactors(lc3)
lc3 <- scater::logNormCounts(lc3)

## read in nm subclusterings
lcnm <- fread("processed-data/10_subclustering/04-LCsubclus-by-NM_otherclusts-by-LCorLCNMadjacency.txt")
lcnm <- lcnm[,.(rn,NMseg_subclus)]
lcnm <- DataFrame(lcnm,row.names=lcnm$rn)[colnames(lc3),]

## assign
colLabels(lc3) <- lcnm$NMseg_subclus

# subset to LC NM+, make rownames symbols
lcnm <- lc3[,lc3$label=="LC.1_NMpos"]
rownames(lcnm) <- rowData(lcnm)$gene_name
rm(lc3)
gc()

### get metadata -- only intensity and proportion for NM measures are continuous and appropriate for an LMM. (the N nm bodies and centroid signal count are both counts, and would require GLMMs). we can still inspect top genes from the continuous measures plotting across all four metrics with plots later.

lcnm.cd <- as.data.table(colData(lcnm),keep.rownames=T)

## add column for E4 copies
lcnm.cd[,e4copies:=0]
lcnm.cd[APOE=="E3/ E4",e4copies:=1]
lcnm.cd[APOE=="E4/ E4",e4copies:=2]
lcnm.cd[,APOE:=NULL]

## subset to covars and NM measures
lcnm.cd <- lcnm.cd[,.(rn,N_NMbodies,CentroidSignalCount_NM,Intensity_NM,Prop_NM,Age,Sex,e4copies,sample_id)]



## get logcounts matrix for the candidate genes, merge in coldata with corresp. spot level NM metrics
keepg <- unique(nms.allcoefs$gene_name)
lcnm.lct <- logcounts(lcnm[keepg,])
lcnm.lct <- as.data.frame(t(as.matrix(lcnm.lct)))
lcnm.lct <- as.data.table(lcnm.lct,keep.rownames=T)

# make longass table
lcnm.lct2 <- melt.data.table(lcnm.lct,id.vars="rn")
# add NM vars
lcnm.lct2 <- merge.data.table(lcnm.lct2,lcnm.cd,by="rn")
# melt again with the NM vars
setnames(lcnm.lct2,c("value","variable"),c("logcounts","gene_name"))
lcnm.lct2 <- melt.data.table(lcnm.lct2,id.vars=c("rn","gene_name","logcounts","Age","Sex","e4copies","sample_id"))
setnames(lcnm.lct2,"variable","NMvar")
setnames(lcnm.lct2,"value","NMvalue")

rm(lcnm.lct,lcnm,nms,keepg)
gc(full=T)
```

```{r}
## get just the signif NM coefficient(s) per gene
nms.pltdat <- nms.allcoefs[rn %in% grep(rn,pattern="NM",value=T)]

## make e4copies a factor
lcnm.lct2[,e4copies:=as.factor(e4copies)]

lapply(unique(nms.pltdat$gene_name),function(g){
    if(nrow(nms.pltdat[gene_name==g])==1){
        ptitle <- paste0(g,": ",nms.pltdat[gene_name==g,rn]," coef ",round(nms.pltdat[gene_name==g,coef],3))
    }
    else{
        ptitle <- paste0(g,": ",nms.pltdat[gene_name==g,rn],paste0(" coef ",nms.pltdat[gene_name==g,round(coef,3)]),collapse="<br>")
    }
    
    ## determine if there's a covariate to color code. if multiple, take the most signif one
    
    if(nrow(nms.allcoefs[gene_name==g&
                        !(rn %in% grep(rn,pattern="NM",value=T))&
                        p<0.05])>0){
        plotcov <- nms.allcoefs[gene_name==g&
                        !(rn %in% grep(rn,pattern="NM",value=T))][p==min(p),rn]
    } else{
        plotcov <- NA
    }
     
    p <- ggplot(lcnm.lct2[gene_name==g],aes(x=NMvalue,y=logcounts))+
        geom_point(size=0.2)+
        facet_wrap(~NMvar,scales="free")+
        ggtitle(ptitle)
    
    if(!is.na(plotcov)){
        p<-p+aes(col=.data[[plotcov]])
    }
    
    p2samp <- lcnm.lct2[gene_name==g,.N,by="sample_id"][N>=100,sample_id]
    p2dat <- lcnm.lct2[gene_name==g&sample_id %in% p2samp]
    p2 <- ggplot(p2dat,aes(x=NMvalue,y=logcounts))+
        geom_line(aes(group=sample_id),linewidth=0.1)+
        facet_wrap(~NMvar,scales="free")+
        ggtitle(paste0("Line per sample w/ 100+ LCNM spots"))
    
    if(!is.na(plotcov)){
        p2<-p2+aes(col=.data[[plotcov]])
    }
        
    
    pdf(paste0("plots/Xenium_prioritization/05-NMassoc_genes/",g,".pdf"),height=17,width=14)
    do.call("grid.arrange",c(list(p,p2),ncol=1))
    dev.off()
})


```

repinf
```{r}
sessionInfo()
sessioninfo::session_info()
```

R version 4.4.2 (2024-10-31)
Platform: aarch64-apple-darwin20
Running under: macOS Sonoma 14.7.1

Matrix products: default
BLAS:   /System/Library/Frameworks/Accelerate.framework/Versions/A/Frameworks/vecLib.framework/Versions/A/libBLAS.dylib 
LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0

locale:
[1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8

time zone: America/Chicago
tzcode source: internal

attached base packages:
[1] stats4    stats     graphics  grDevices utils     methods   base     

other attached packages:
 [1] SpatialExperiment_1.16.0    SingleCellExperiment_1.28.1
 [3] SummarizedExperiment_1.36.0 Biobase_2.66.0             
 [5] GenomicRanges_1.58.0        GenomeInfoDb_1.42.1        
 [7] IRanges_2.40.1              S4Vectors_0.44.0           
 [9] BiocGenerics_0.52.0         MatrixGenerics_1.18.0      
[11] matrixStats_1.5.0           BiocParallel_1.40.0        
[13] parallelly_1.42.0           colorout_1.3-0.2           
[15] gridExtra_2.3               ggtext_0.1.2               
[17] ggplot2_3.5.1               data.table_1.16.4          
[19] rlang_1.1.4                

loaded via a namespace (and not attached):
 [1] tidyselect_1.2.1        viridisLite_0.4.2       dplyr_1.1.4            
 [4] vipor_0.4.7             farver_2.1.2            viridis_0.6.5          
 [7] fastmap_1.2.0           digest_0.6.37           rsvd_1.0.5             
[10] lifecycle_1.0.4         magrittr_2.0.3          compiler_4.4.2         
[13] tools_4.4.2             yaml_2.3.10             knitr_1.49             
[16] S4Arrays_1.6.0          labeling_0.4.3          here_1.0.1             
[19] DelayedArray_0.32.0     xml2_1.3.6              abind_1.4-8            
[22] withr_3.0.2             grid_4.4.2              beachmat_2.22.0        
[25] colorspace_2.1-1        scales_1.3.0            cli_3.6.3              
[28] rmarkdown_2.29          crayon_1.5.3            generics_0.1.3         
[31] rstudioapi_0.17.1       httr_1.4.7              rjson_0.2.23           
[34] commonmark_1.9.2        scuttle_1.16.0          ggbeeswarm_0.7.2       
[37] stringr_1.5.1           zlibbioc_1.52.0         datasets_4.4.2         
[40] parallel_4.4.2          XVector_0.46.0          vctrs_0.6.5            
[43] Matrix_1.7-1            jsonlite_1.8.9          BiocSingular_1.22.0    
[46] BiocNeighbors_2.0.1     ggrepel_0.9.6           irlba_2.3.5.1          
[49] beeswarm_0.4.0          scater_1.34.0           magick_2.8.5           
[52] glue_1.8.0              codetools_0.2-20        stringi_1.8.4          
[55] gtable_0.3.6            UCSC.utils_1.2.0        ScaledMatrix_1.14.0    
[58] munsell_0.5.1           tibble_3.2.1            pillar_1.10.1          
[61] htmltools_0.5.8.1       GenomeInfoDbData_1.2.13 R6_2.5.1               
[64] rprojroot_2.0.4         evaluate_1.0.3          lattice_0.22-6         
[67] markdown_1.13           gridtext_0.1.5          Rcpp_1.0.14            
[70] SparseArray_1.6.0       xfun_0.50               pkgconfig_2.0.3        
> sessioninfo::session_info()
─ Session info ─────────────────────────────────────────────────────────────────────
 setting  value
 version  R version 4.4.2 (2024-10-31)
 os       macOS Sonoma 14.7.1
 system   aarch64, darwin20
 ui       RStudio
 language (EN)
 collate  en_US.UTF-8
 ctype    en_US.UTF-8
 tz       America/Chicago
 date     2025-03-01
 rstudio  2024.07.0-daily+219 Cranberry Hibiscus (desktop)
 pandoc   3.1.11 @ /Applications/RStudio.app/Contents/Resources/app/quarto/bin/tools/aarch64/ (via rmarkdown)

─ Packages ─────────────────────────────────────────────────────────────────────────
 !  package              * version date (UTC) lib source
    abind                  1.4-8   2024-09-12 [1] CRAN (R 4.4.1)
    beachmat               2.22.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    beeswarm               0.4.0   2021-06-01 [1] CRAN (R 4.4.0)
    Biobase              * 2.66.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    BiocGenerics         * 0.52.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    BiocNeighbors          2.0.1   2024-11-28 [1] Bioconductor 3.20 (R 4.4.2)
    BiocParallel         * 1.40.0  2024-11-23 [1] Bioconductor 3.20 (R 4.4.2)
    BiocSingular           1.22.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
 P  cli                    3.6.3   2024-06-21 [2] CRAN (R 4.4.0)
    codetools              0.2-20  2024-03-31 [1] CRAN (R 4.4.2)
    colorout             * 1.3-0.2 2024-05-01 [1] Github (jalvesaq/colorout@c6113a2)
    colorspace             2.1-1   2024-07-26 [1] CRAN (R 4.4.0)
    commonmark             1.9.2   2024-10-04 [1] CRAN (R 4.4.1)
    crayon                 1.5.3   2024-06-20 [1] CRAN (R 4.4.0)
    data.table           * 1.16.4  2024-12-06 [1] CRAN (R 4.4.1)
    DelayedArray           0.32.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    digest                 0.6.37  2024-08-19 [1] CRAN (R 4.4.1)
    dplyr                  1.1.4   2023-11-17 [1] CRAN (R 4.4.0)
    evaluate               1.0.3   2025-01-10 [1] CRAN (R 4.4.1)
    farver                 2.1.2   2024-05-13 [1] CRAN (R 4.4.0)
    fastmap                1.2.0   2024-05-15 [1] CRAN (R 4.4.0)
    generics               0.1.3   2022-07-05 [1] CRAN (R 4.4.0)
    GenomeInfoDb         * 1.42.1  2024-11-28 [1] Bioconductor 3.20 (R 4.4.2)
    GenomeInfoDbData       1.2.13  2024-12-12 [1] Bioconductor
    GenomicRanges        * 1.58.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    ggbeeswarm             0.7.2   2023-04-29 [1] CRAN (R 4.4.0)
    ggplot2              * 3.5.1   2024-04-23 [1] CRAN (R 4.4.0)
    ggrepel                0.9.6   2024-09-07 [1] CRAN (R 4.4.1)
    ggtext               * 0.1.2   2022-09-16 [1] CRAN (R 4.4.0)
    glue                   1.8.0   2024-09-30 [1] CRAN (R 4.4.1)
    gridExtra            * 2.3     2017-09-09 [1] CRAN (R 4.4.0)
    gridtext               0.1.5   2022-09-16 [1] CRAN (R 4.4.0)
    gtable                 0.3.6   2024-10-25 [1] CRAN (R 4.4.1)
    here                   1.0.1   2020-12-13 [1] CRAN (R 4.4.0)
    htmltools              0.5.8.1 2024-04-04 [1] CRAN (R 4.4.0)
    httr                   1.4.7   2023-08-15 [1] CRAN (R 4.4.0)
    IRanges              * 2.40.1  2024-12-05 [1] Bioconductor 3.20 (R 4.4.2)
    irlba                  2.3.5.1 2022-10-03 [1] CRAN (R 4.4.0)
    jsonlite               1.8.9   2024-09-20 [1] CRAN (R 4.4.1)
    knitr                  1.49    2024-11-08 [1] CRAN (R 4.4.1)
    labeling               0.4.3   2023-08-29 [1] CRAN (R 4.4.0)
    lattice                0.22-6  2024-03-20 [1] CRAN (R 4.4.2)
    lifecycle              1.0.4   2023-11-07 [1] CRAN (R 4.4.0)
    magick                 2.8.5   2024-09-20 [1] CRAN (R 4.4.1)
    magrittr               2.0.3   2022-03-30 [1] CRAN (R 4.4.0)
    markdown               1.13    2024-06-04 [1] CRAN (R 4.4.0)
    Matrix                 1.7-1   2024-10-18 [1] CRAN (R 4.4.2)
    MatrixGenerics       * 1.18.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    matrixStats          * 1.5.0   2025-01-07 [1] CRAN (R 4.4.1)
    munsell                0.5.1   2024-04-01 [1] CRAN (R 4.4.0)
    parallelly           * 1.42.0  2025-01-30 [1] CRAN (R 4.4.1)
    pillar                 1.10.1  2025-01-07 [1] CRAN (R 4.4.1)
    pkgconfig              2.0.3   2019-09-22 [1] CRAN (R 4.4.0)
    R6                     2.5.1   2021-08-19 [1] CRAN (R 4.4.0)
    Rcpp                   1.0.14  2025-01-12 [1] CRAN (R 4.4.1)
    rjson                  0.2.23  2024-09-16 [1] CRAN (R 4.4.1)
 VP rlang                * 1.1.4   2025-01-17 [2] CRAN (R 4.4.1) (on disk 1.1.5)
    rmarkdown              2.29    2024-11-04 [1] CRAN (R 4.4.1)
    rprojroot              2.0.4   2023-11-05 [1] CRAN (R 4.4.0)
    rstudioapi             0.17.1  2024-10-22 [1] CRAN (R 4.4.1)
    rsvd                   1.0.5   2021-04-16 [1] CRAN (R 4.4.0)
    S4Arrays               1.6.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    S4Vectors            * 0.44.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    ScaledMatrix           1.14.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    scales                 1.3.0   2023-11-28 [1] CRAN (R 4.4.0)
    scater                 1.34.0  2024-10-29 [1] Bioconductor 3.20 (R 4.4.1)
    scuttle                1.16.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    sessioninfo            1.2.2   2021-12-06 [1] CRAN (R 4.4.0)
    SingleCellExperiment * 1.28.1  2024-11-23 [1] Bioconductor 3.20 (R 4.4.2)
    SparseArray            1.6.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    SpatialExperiment    * 1.16.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    stringi                1.8.4   2024-05-06 [1] CRAN (R 4.4.0)
    stringr                1.5.1   2023-11-14 [1] CRAN (R 4.4.0)
    SummarizedExperiment * 1.36.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    tibble                 3.2.1   2023-03-20 [1] CRAN (R 4.4.0)
    tidyselect             1.2.1   2024-03-11 [1] CRAN (R 4.4.0)
    UCSC.utils             1.2.0   2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    vctrs                  0.6.5   2023-12-01 [1] CRAN (R 4.4.0)
    vipor                  0.4.7   2023-12-18 [1] CRAN (R 4.4.0)
    viridis                0.6.5   2024-01-29 [1] CRAN (R 4.4.0)
    viridisLite            0.4.2   2023-05-02 [1] CRAN (R 4.4.0)
    withr                  3.0.2   2024-10-28 [1] CRAN (R 4.4.1)
    xfun                   0.50    2025-01-07 [1] CRAN (R 4.4.1)
    xml2                   1.3.6   2023-12-04 [1] CRAN (R 4.4.0)
    XVector                0.46.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)
    yaml                   2.3.10  2024-07-26 [1] CRAN (R 4.4.0)
    zlibbioc               1.52.0  2024-11-08 [1] Bioconductor 3.20 (R 4.4.1)

 [1] /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/library
 [2] /Users/bmulvey/Library/R/arm64/4.4/library

 V ── Loaded and on-disk version mismatch.
 P ── Loaded and on-disk path mismatch.

────────────────────────────────────────────────────────────────────────────────────
